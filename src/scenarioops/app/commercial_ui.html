<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ScenarioOps War Room</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=IBM+Plex+Mono:wght@400;500;600&display=swap");

      :root {
        --bg: radial-gradient(1200px 800px at 20% 10%, rgba(33, 66, 148, 0.35), transparent 60%),
          radial-gradient(1000px 700px at 80% 0%, rgba(0, 153, 255, 0.25), transparent 60%),
          linear-gradient(135deg, #05070f 0%, #0b1020 50%, #0a0f1d 100%);
        --ink: #e6ecff;
        --muted: rgba(205, 216, 255, 0.6);
        --glass: rgba(15, 24, 44, 0.6);
        --glass-strong: rgba(15, 24, 44, 0.85);
        --edge: rgba(110, 140, 200, 0.25);
        --accent: #3aa4ff;
        --accent-2: #28f0c8;
        --success: #33e49a;
        --warn: #f1b64f;
        --error: #ff5c77;
        --shadow: 0 20px 40px rgba(5, 12, 24, 0.45);
        --font-body: "Space Grotesk", "Segoe UI", sans-serif;
        --font-mono: "IBM Plex Mono", "Consolas", monospace;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: var(--font-body);
        color: var(--ink);
        background: var(--bg);
        min-height: 100vh;
      }

      a {
        color: inherit;
        text-decoration: none;
      }

      .page {
        max-width: 1400px;
        margin: 0 auto;
        padding: 24px 28px 80px;
      }

      .glass {
        background: var(--glass);
        border: 1px solid var(--edge);
        border-radius: 18px;
        box-shadow: var(--shadow);
        backdrop-filter: blur(14px);
      }

      .glass-strong {
        background: var(--glass-strong);
      }

      .status-bar {
        display: grid;
        grid-template-columns: 1.4fr 1fr 1fr 1.2fr;
        gap: 16px;
        padding: 16px 20px;
        align-items: center;
      }

      .status-left {
        display: flex;
        align-items: center;
        gap: 14px;
      }

      .pulse {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: var(--accent);
        box-shadow: 0 0 12px rgba(58, 164, 255, 0.9);
        position: relative;
      }

      .pulse::after {
        content: "";
        position: absolute;
        inset: -6px;
        border-radius: 50%;
        border: 1px solid rgba(58, 164, 255, 0.6);
        animation: pulse 2s infinite;
      }

      .pulse.off {
        background: var(--warn);
        box-shadow: 0 0 12px rgba(241, 182, 79, 0.8);
      }

      .pulse.off::after {
        border-color: rgba(241, 182, 79, 0.5);
        animation: none;
      }

      @keyframes pulse {
        0% {
          opacity: 0.8;
          transform: scale(0.7);
        }
        70% {
          opacity: 0.1;
          transform: scale(1.4);
        }
        100% {
          opacity: 0;
          transform: scale(1.6);
        }
      }

      .context-ribbon {
        display: flex;
        gap: 10px;
        font-size: 13px;
        color: var(--muted);
      }

      .context-pill {
        padding: 4px 10px;
        border-radius: 999px;
        background: rgba(58, 164, 255, 0.15);
        border: 1px solid rgba(58, 164, 255, 0.35);
        font-size: 12px;
      }

      .status-actions {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
      }

      button {
        border: none;
        border-radius: 999px;
        padding: 8px 16px;
        font-weight: 600;
        cursor: pointer;
        background: rgba(58, 164, 255, 0.2);
        color: var(--ink);
        border: 1px solid rgba(58, 164, 255, 0.35);
      }

      button.primary {
        background: linear-gradient(120deg, rgba(58, 164, 255, 0.9), rgba(40, 240, 200, 0.7));
        color: #051022;
        border: none;
      }

      .top-nav {
        margin-top: 18px;
        display: flex;
        gap: 14px;
        padding: 10px 16px;
        align-items: center;
      }

      .nav-link {
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.12em;
        color: var(--muted);
        padding: 8px 14px;
        border-radius: 999px;
      }

      .nav-link.active {
        background: rgba(58, 164, 255, 0.2);
        color: var(--ink);
        border: 1px solid rgba(58, 164, 255, 0.4);
      }

      .section {
        margin-top: 24px;
      }

      .section-title {
        font-size: 18px;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--muted);
        margin-bottom: 12px;
      }

      .kpi-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 16px;
      }

      .kpi-card {
        padding: 16px;
      }

      .kpi-card h3 {
        margin: 0;
        font-size: 14px;
        color: var(--muted);
        letter-spacing: 0.1em;
        text-transform: uppercase;
      }

      .kpi-card p {
        margin: 10px 0 0;
        font-size: 24px;
        font-weight: 600;
      }

      .layout-grid {
        display: grid;
        grid-template-columns: 320px 1.2fr 360px;
        gap: 16px;
      }

      .sidebar {
        padding: 16px;
      }

      .sidebar-stack {
        display: grid;
        gap: 12px;
      }

      .sidebar-card {
        padding: 12px;
      }

      .company-card {
        padding: 14px;
        margin-bottom: 14px;
      }

      .company-header {
        display: flex;
        gap: 12px;
        align-items: center;
        margin-bottom: 10px;
      }

      .company-logo {
        width: 48px;
        height: 48px;
        border-radius: 14px;
        background: linear-gradient(135deg, rgba(58, 164, 255, 0.6), rgba(40, 240, 200, 0.5));
        color: #051022;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        letter-spacing: 0.08em;
      }

      .company-meta {
        font-size: 12px;
        color: var(--muted);
      }

      .kpi-list {
        display: grid;
        gap: 8px;
        margin-top: 10px;
      }

      .kpi-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 6px 10px;
        border-radius: 10px;
        border: 1px solid rgba(110, 140, 200, 0.25);
        background: rgba(15, 24, 44, 0.45);
        font-size: 12px;
      }

      .sidebar label,
      .form label {
        display: grid;
        gap: 6px;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--muted);
        width: 100%;
      }

      .sidebar input,
      .sidebar select,
      .form input,
      .form select,
      .form textarea {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(110, 140, 200, 0.3);
        border-radius: 10px;
        padding: 8px 10px;
        color: #f5f8ff;
        font-weight: 600;
        opacity: 1;
        font-family: var(--font-body);
        width: 100%;
      }

      .sidebar select,
      .form select {
        text-align: left;
        min-height: 38px;
      }

      .sidebar select option,
      .form select option {
        color: #0b1020;
        background: #e7eefc;
      }

      .sidebar select:disabled,
      .form select:disabled {
        color: rgba(205, 216, 255, 0.45);
        cursor: not-allowed;
      }

      .workflow-map {
        padding: 18px;
        min-height: 360px;
      }

      .workflow-nodes {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 14px;
      }

      .node {
        padding: 14px;
        border-radius: 14px;
        background: rgba(58, 164, 255, 0.08);
        border: 1px solid rgba(58, 164, 255, 0.2);
        text-align: center;
        font-size: 13px;
        color: var(--muted);
        cursor: pointer;
      }

      .node.running {
        color: var(--ink);
        box-shadow: 0 0 18px rgba(58, 164, 255, 0.6);
        border-color: rgba(58, 164, 255, 0.6);
      }

      .node.success {
        color: var(--success);
        border-color: rgba(51, 228, 154, 0.5);
      }

      .node.error {
        color: var(--error);
        border-color: rgba(255, 92, 119, 0.6);
      }

      .detail-card {
        padding: 18px;
      }

      .terminal {
        font-family: var(--font-mono);
        font-size: 12px;
        background: rgba(5, 10, 20, 0.75);
        border: 1px solid rgba(110, 140, 200, 0.3);
        border-radius: 14px;
        padding: 14px;
        height: 220px;
        overflow: auto;
      }

      .chat-panel {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .chat-messages {
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-height: 420px;
        overflow: auto;
        padding-right: 6px;
      }

      .chat-message {
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid rgba(110, 140, 200, 0.25);
        background: rgba(15, 24, 44, 0.55);
        font-size: 13px;
        line-height: 1.4;
      }

      .chat-message.user {
        align-self: flex-end;
        background: rgba(58, 164, 255, 0.18);
        border-color: rgba(58, 164, 255, 0.4);
      }

      .chat-message .meta {
        font-size: 11px;
        color: var(--muted);
        margin-bottom: 6px;
      }

      .chat-message .content {
        white-space: pre-wrap;
        font-family: var(--font-body);
      }

      .chat-message .content code {
        font-family: var(--font-mono);
        background: rgba(15, 24, 44, 0.65);
        border: 1px solid rgba(110, 140, 200, 0.25);
        border-radius: 6px;
        padding: 2px 6px;
      }

      .chat-message .content ul {
        margin: 6px 0 6px 18px;
        padding: 0;
      }

      .chat-message .content li {
        margin-bottom: 4px;
      }

      .chat-message .content .chat-heading {
        font-weight: 700;
        margin-top: 6px;
      }

      .chat-message .content .chat-paragraph {
        margin: 4px 0;
      }

      .chat-message .content .chat-spacer {
        height: 8px;
      }

      .chat-input {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .chat-input textarea {
        flex: 1;
        min-height: 54px;
        resize: vertical;
      }

      .ghost {
        background: linear-gradient(90deg, rgba(255, 255, 255, 0.04), rgba(255, 255, 255, 0.12), rgba(255, 255, 255, 0.04));
        background-size: 200% 100%;
        animation: shimmer 1.8s infinite;
      }

      @keyframes shimmer {
        0% { background-position: 0% 0; }
        100% { background-position: -200% 0; }
      }

      .cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 16px;
      }

      .card {
        padding: 14px;
      }

      .action-toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
        margin-bottom: 8px;
      }

      .action-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .action-board {
        margin-top: 12px;
      }

      .action-item {
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid rgba(110, 140, 200, 0.25);
        background: rgba(15, 24, 44, 0.55);
        display: grid;
        gap: 8px;
        font-size: 12px;
      }

      .action-title {
        font-weight: 600;
        font-size: 13px;
        color: var(--ink);
      }

      .action-meta {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
        color: var(--muted);
      }

      .action-meta .chip {
        font-size: 10px;
        padding: 2px 8px;
      }

      .action-fields {
        display: grid;
        gap: 6px;
      }

      .action-fields input,
      .action-fields select,
      .action-fields textarea {
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(110, 140, 200, 0.35);
        border-radius: 10px;
        padding: 6px 8px;
        color: var(--ink);
        font-family: var(--font-body);
        font-size: 12px;
      }

      .action-fields textarea {
        min-height: 54px;
        resize: vertical;
      }

      .action-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 8px;
      }

      .axis-graph {
        display: grid;
        gap: 16px;
      }

      .axis-block {
        display: grid;
        gap: 10px;
      }

      .axis-title {
        font-weight: 600;
        letter-spacing: 0.06em;
        text-transform: uppercase;
        font-size: 12px;
        color: var(--muted);
      }

      .axis-sub {
        font-size: 12px;
        color: var(--muted);
      }

      .axis-bars {
        display: grid;
        gap: 8px;
      }

      .axis-bar {
        position: relative;
        height: 36px;
        border-radius: 999px;
        background: linear-gradient(90deg, rgba(58, 164, 255, 0.35), rgba(40, 240, 200, 0.15));
        border: 1px solid rgba(58, 164, 255, 0.35);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 12px;
        overflow: hidden;
        color: var(--ink);
      }

      .axis-bar span {
        font-size: 12px;
      }

      .axis-score {
        color: var(--muted);
        font-family: var(--font-mono);
      }

      .scenario-card {
        display: flex;
        flex-direction: column;
        padding: 0;
        overflow: hidden;
      }

      .scenario-card .scenario-media {
        width: 100%;
        height: 150px;
        background: rgba(10, 16, 32, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        border-bottom: 1px solid rgba(110, 140, 200, 0.25);
      }

      .scenario-card .scenario-media img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }

      @media (max-width: 1100px) {
        .page {
          padding: 18px 18px 64px;
        }

        .status-bar {
          grid-template-columns: 1fr;
        }

        .status-actions {
          justify-content: flex-start;
          flex-wrap: wrap;
        }

        .context-ribbon {
          flex-wrap: wrap;
        }

        .layout-grid {
          grid-template-columns: 1fr;
        }

        .top-nav {
          flex-wrap: wrap;
        }
      }

      @media (max-width: 720px) {
        .page {
          padding: 14px 14px 56px;
        }

        .status-bar {
          gap: 12px;
          padding: 14px 16px;
        }

        .status-actions button,
        .status-actions a {
          flex: 1 1 auto;
        }

        .top-nav {
          overflow-x: auto;
          -webkit-overflow-scrolling: touch;
        }

        .top-nav::-webkit-scrollbar {
          display: none;
        }

        .nav-link {
          white-space: nowrap;
        }

        .kpi-card p {
          font-size: 20px;
        }

        .scenario-card .scenario-media {
          height: 170px;
        }

        .chat-input {
          flex-direction: column;
          align-items: stretch;
        }

        .chat-input textarea {
          width: 100%;
        }

        .chat-input button {
          width: 100%;
        }

        .modal-actions {
          flex-wrap: wrap;
          justify-content: stretch;
        }

        .modal-actions button {
          flex: 1 1 auto;
        }
      }

      @media (max-width: 480px) {
        .section-title {
          font-size: 16px;
        }

        button {
          padding: 10px 14px;
        }

        .context-pill {
          font-size: 11px;
        }

        .axis-bar {
          height: 32px;
        }
      }

      .scenario-card .scenario-media.placeholder {
        background: linear-gradient(135deg, rgba(58, 164, 255, 0.25), rgba(40, 240, 200, 0.15));
        display: flex;
        align-items: center;
        justify-content: center;
        color: rgba(230, 236, 255, 0.7);
        font-size: 12px;
        letter-spacing: 0.12em;
        text-transform: uppercase;
      }

      .scenario-card .scenario-body {
        padding: 12px 14px;
        display: flex;
        flex-direction: column;
        gap: 6px;
        flex: 1;
      }

      .scenario-card .scenario-meta {
        margin-top: 6px;
        font-size: 11px;
        color: var(--muted);
      }

      .scenario-card p {
        white-space: pre-wrap;
      }

      .chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        border-radius: 999px;
        padding: 4px 10px;
        background: rgba(58, 164, 255, 0.2);
        border: 1px solid rgba(58, 164, 255, 0.4);
        font-size: 12px;
        color: var(--ink);
      }

      .matrix {
        overflow-x: auto;
      }

      .matrix table {
        width: 100%;
        border-collapse: collapse;
        min-width: 640px;
      }

      .matrix th,
      .matrix td {
        border: 1px solid rgba(110, 140, 200, 0.2);
        padding: 10px;
        text-align: center;
        font-size: 12px;
      }

      .matrix th {
        background: rgba(58, 164, 255, 0.15);
        color: var(--ink);
      }

      .hidden {
        display: none;
      }

      .tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 10px;
      }

      .tab {
        padding: 6px 12px;
        border-radius: 999px;
        border: 1px solid rgba(110, 140, 200, 0.35);
        color: var(--muted);
        cursor: pointer;
        font-size: 12px;
      }

      .tab.active {
        color: var(--ink);
        background: rgba(58, 164, 255, 0.25);
      }

      .ghost {
        background: linear-gradient(110deg, rgba(255, 255, 255, 0.06) 8%, rgba(255, 255, 255, 0.14) 18%, rgba(255, 255, 255, 0.06) 33%);
        background-size: 200% 100%;
        animation: shimmer 2s infinite linear;
        color: transparent;
      }

      @keyframes shimmer {
        0% {
          background-position: 200% 0;
        }
        100% {
          background-position: -200% 0;
        }
      }

      .modal {
        position: fixed;
        inset: 0;
        background: rgba(4, 8, 16, 0.75);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 40;
      }

      .modal.hidden {
        display: none;
      }

      .modal-card {
        width: min(640px, 92vw);
        padding: 20px;
      }

      .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        margin-top: 12px;
      }

      .helper {
        font-size: 12px;
        color: var(--muted);
      }

      .run-list {
        margin-top: 10px;
        display: grid;
        gap: 8px;
        max-height: 180px;
        overflow: auto;
      }

      .run-item {
        padding: 8px 10px;
        border-radius: 12px;
        border: 1px solid rgba(110, 140, 200, 0.3);
        background: rgba(15, 24, 44, 0.4);
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 12px;
      }

      .run-label {
        flex: 1;
        min-width: 0;
      }

      .run-actions {
        display: flex;
        gap: 6px;
        align-items: center;
      }

      .badge {
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 10px;
        background: rgba(58, 164, 255, 0.2);
        border: 1px solid rgba(58, 164, 255, 0.35);
      }

      .badge.danger {
        background: rgba(255, 99, 132, 0.2);
        border-color: rgba(255, 99, 132, 0.4);
        color: #ffb3c7;
      }

      .node {
        padding: 16px 10px;
        text-align: center;
        border-radius: 18px;
        border: 1px solid rgba(110, 140, 200, 0.3);
        background: rgba(15, 24, 44, 0.6);
        text-transform: capitalize;
        font-size: 12px;
        letter-spacing: 0.06em;
        clip-path: polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      .node:hover {
        transform: translateY(-2px);
        box-shadow: 0 0 18px rgba(58, 164, 255, 0.35);
      }

      .node.running {
        box-shadow: 0 0 18px rgba(58, 164, 255, 0.7);
        border-color: rgba(58, 164, 255, 0.6);
      }

      .node.success {
        border-color: rgba(51, 228, 154, 0.7);
        box-shadow: 0 0 16px rgba(51, 228, 154, 0.5);
      }

      .node.error {
        border-color: rgba(255, 92, 119, 0.7);
        box-shadow: 0 0 16px rgba(255, 92, 119, 0.5);
      }

      .node.disabled {
        opacity: 0.35;
        filter: grayscale(0.8);
        cursor: not-allowed;
        box-shadow: none;
        border-color: rgba(110, 140, 200, 0.2);
      }

      .node.disabled:hover {
        transform: none;
        box-shadow: none;
      }

      .run-steps {
        margin-top: 10px;
        display: grid;
        gap: 6px;
        font-size: 12px;
      }

      .run-step {
        display: flex;
        justify-content: space-between;
        padding: 6px 8px;
        border-radius: 8px;
        background: rgba(15, 24, 44, 0.5);
        border: 1px solid rgba(110, 140, 200, 0.2);
      }

      .run-step.status-ok {
        background: rgba(56, 196, 132, 0.2);
        border-color: rgba(56, 196, 132, 0.45);
      }

      .run-step.status-running {
        background: rgba(242, 198, 90, 0.22);
        border-color: rgba(242, 198, 90, 0.55);
      }

      .run-step.status-failed {
        background: rgba(232, 92, 104, 0.2);
        border-color: rgba(232, 92, 104, 0.55);
      }

      .run-step.status-skipped {
        background: rgba(110, 140, 200, 0.12);
        border-color: rgba(110, 140, 200, 0.3);
        color: rgba(210, 220, 250, 0.7);
      }

      .run-step.status-pending {
        background: transparent;
      }

      .config-editor {
        width: 100%;
        font-family: var(--font-mono);
        background: rgba(9, 15, 30, 0.85);
        border: 1px solid rgba(110, 140, 200, 0.35);
        border-radius: 12px;
        padding: 10px 12px;
        color: #f5f8ff;
        min-height: 220px;
      }

      .config-label {
        margin: 12px 0 6px;
        font-size: 12px;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.18em;
      }

      .matrix td {
        position: relative;
      }

      .grade {
        font-size: 18px;
        font-weight: 700;
      }

      .score {
        font-size: 11px;
        color: var(--muted);
      }

      .confidence {
        font-size: 10px;
        color: var(--muted);
        text-transform: uppercase;
      }

      .status-pill {
        padding: 4px 10px;
        border-radius: 999px;
        border: 1px solid rgba(110, 140, 200, 0.3);
        background: rgba(15, 24, 44, 0.5);
        font-size: 12px;
      }

      .tag {
        display: inline-flex;
        gap: 6px;
        align-items: center;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 11px;
        background: rgba(40, 240, 200, 0.12);
        border: 1px solid rgba(40, 240, 200, 0.4);
      }

      .card-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 16px;
      }
    </style>
  </head>
  <body>
    <div class="page">
      <div class="glass status-bar">
        <div class="status-left">
          <div class="pulse" id="pulseIndicator"></div>
          <div>
            <div style="font-size: 12px; letter-spacing: 0.2em; text-transform: uppercase; color: var(--muted);">
              ScenarioOps War Room
            </div>
            <div id="statusText" style="font-weight: 600;">Connecting...</div>
            <div id="statusDetail" class="helper">Awaiting connection.</div>
            <div id="apiKeyStatus" class="helper"></div>
          </div>
        </div>
        <div class="context-ribbon" id="contextRibbon"></div>
        <div id="runState" class="status-pill">Idle</div>
        <div class="status-actions">
          <button id="accessBtn">Access</button>
          <button id="configBtn">Config</button>
          <button id="helpBtn">?</button>
          <button id="newRunBtn">New Run</button>
          <button id="openLatestBtn">Open Latest</button>
        </div>
      </div>

      <nav class="glass top-nav" id="navBar">
        <a class="nav-link" data-route="/" href="/">Command Center</a>
        <a class="nav-link" data-route="/intelligence" href="/intelligence">Intelligence</a>
        <a class="nav-link" data-route="/scenarios" href="/scenarios">Scenario Lab</a>
        <a class="nav-link" data-route="/wind-tunnel" href="/wind-tunnel">Wind Tunnel</a>
        <a class="nav-link" data-route="/actions" href="/actions">Action Console</a>
        <a class="nav-link" data-route="/chat" href="/chat">Advisor</a>
      </nav>

      <section class="section" data-view="/runs">
        <div class="glass" id="emptyState" style="padding: 18px; margin-bottom: 16px; display: none;">
          <div style="font-size: 24px; font-weight: 600;">No runs available.</div>
          <div class="helper">Check your API access or create a new run.</div>
        </div>

        <div class="glass" style="padding: 18px; margin-bottom: 18px;">
          <div class="section-title">Strategic Forge</div>
          <div class="form" id="wizard">
            <div id="wizardSteps"></div>
            <div style="margin-top: 12px; display:flex; gap:10px;">
              <button id="prevStep">Back</button>
              <button class="primary" id="nextStep">Next</button>
              <button class="primary" id="launchRun">Launch Run</button>
            </div>
            <div id="runStatus" class="helper" style="margin-top: 10px;"></div>
          </div>
          <details style="margin-top:12px;" id="advancedPanel">
            <summary style="cursor:pointer;">Developer Overrides (advanced)</summary>
            <div class="helper" style="margin: 8px 0 12px;">
              Configure precise model + data settings. These map to runtime settings overrides.
            </div>
            <div class="card-grid">
              <label>LLM Model<select id="advLlmModel">
                <option value="">Default</option>
                <option value="gemini-3-flash-preview">Gemini 3 Flash</option>
                <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
                <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
              </select></label>
              <label>Search Model<select id="advSearchModel">
                <option value="">Default</option>
                <option value="gemini-3-flash-preview">Gemini 3 Flash</option>
                <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
                <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
              </select></label>
              <label>Summarizer Model<select id="advSummarizerModel">
                <option value="">Default</option>
                <option value="gemini-3-flash-preview">Gemini 3 Flash</option>
                <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
                <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
              </select></label>
              <label>Image Model<select id="advImageModel">
                <option value="">Default</option>
                <option value="gemini-2.5-flash-image">Gemini 2.5 Flash Image</option>
                <option value="imagen-3.0-generate-002">Imagen 3</option>
              </select></label>
              <label>Embedding Model<input id="advEmbedModel" placeholder="local-hash-256" /></label>
              <label>Temperature<input id="advTemperature" type="number" step="0.1" min="0" max="2" placeholder="0.2" /></label>
              <label>Seed<input id="advSeed" type="number" placeholder="Optional" /></label>
              <label>Sources Policy<select id="advSourcesPolicy">
                <option value="">Default</option>
                <option value="fixtures">Fixtures</option>
                <option value="academic_only">Academic Only</option>
                <option value="mixed_reputable">Mixed Reputable</option>
              </select></label>
              <label>Allow Web<select id="advAllowWeb">
                <option value="">Default</option>
                <option value="true">True</option>
                <option value="false">False</option>
              </select></label>
              <label>Simulate Evidence<select id="advSimulateEvidence">
                <option value="">Default</option>
                <option value="true">True</option>
                <option value="false">False</option>
              </select></label>
              <label>Min Sources / Domain<input id="advMinSourcesDomain" type="number" placeholder="8" /></label>
              <label>Min Citations / Driver<input id="advMinCitations" type="number" placeholder="2" /></label>
              <label>Min Forces<input id="advMinForces" type="number" placeholder="60" /></label>
              <label>Min Forces / Domain<input id="advMinForcesDomain" type="number" placeholder="10" /></label>
              <label>Min Evidence OK<input id="advMinEvidenceOk" type="number" placeholder="10" /></label>
              <label>Min Evidence Total<input id="advMinEvidenceTotal" type="number" placeholder="15" /></label>
              <label>Max Failed Ratio<input id="advMaxFailedRatio" type="number" step="0.05" placeholder="Optional" /></label>
            </div>
            <details style="margin-top: 12px;">
              <summary style="cursor:pointer;">Preview (read-only)</summary>
              <textarea id="advancedPreview" rows="6" style="width:100%; font-family: var(--font-mono);" readonly></textarea>
            </details>
          </details>
        </div>

        <div class="section">
          <div class="glass" style="padding: 18px;">
            <div class="section-title">Executive Briefing</div>
            <div id="briefing" class="ghost" style="border-radius: 12px; padding: 14px; min-height: 80px;"></div>
          </div>
        </div>

        <div class="section layout-grid">
          <aside class="glass sidebar">
            <div class="section-title">Company Detail</div>
            <div class="sidebar-stack" style="margin-bottom: 16px;">
              <div class="glass card sidebar-card">
                <div class="section-title">Company Overview</div>
                <p id="companyOverview" class="helper">Awaiting data.</p>
              </div>
              <div class="glass card sidebar-card">
                <div class="section-title">Strategic Focus</div>
                <p id="strategicFocus" class="helper">Awaiting data.</p>
              </div>
              <div class="glass card sidebar-card">
                <div class="section-title">Node Reference</div>
                <div id="nodeReference" class="helper">Charter, Focal Issue, Company Profile, Ingest Docs, Retrieval Real, Forces, EBE Rank, Clusters, Uncertainty Axes, Scenarios, Scenario Media, Strategies, Wind Tunnel, Auditor.</div>
              </div>
            </div>
          </aside>

          <div>
            <div class="glass workflow-map">
              <div class="section-title">Workflow Map</div>
              <div class="workflow-nodes" id="workflowNodes"></div>
            </div>

            <div class="glass detail-card" id="nodeDetail" style="margin-top: 16px;">
              <div class="section-title">Run Progress</div>
              <div id="runProgress" class="helper" style="margin-bottom: 12px;">No run loaded.</div>
              <div class="section-title">Node Detail</div>
              <div id="nodeDetailBody" class="ghost" style="padding: 12px; border-radius: 12px; min-height: 200px;"></div>
              <div class="section-title" style="margin-top: 14px;">Artifacts</div>
              <div id="artifactList" class="run-steps"></div>
            </div>
          </div>

          <aside class="glass sidebar">
            <div class="section-title">Run Controls</div>
            <div class="glass company-card">
              <div class="company-header">
                <div class="company-logo" id="companyLogo">SO</div>
                <div>
                  <div id="companyName" style="font-weight: 600;">Company</div>
                  <div id="companyMarket" class="company-meta">Market ??? Region</div>
                </div>
              </div>
              <div id="companySummary" class="company-meta">Awaiting profile data.</div>
              <div id="runMeta" class="company-meta" style="margin-top: 8px;"></div>
              <div class="kpi-list">
                <div class="kpi-item"><span>Market Volatility</span><strong id="kpiVolatility">--</strong></div>
                <div class="kpi-item"><span>Strategy Confidence</span><strong id="kpiConfidence">--</strong></div>
                <div class="kpi-item"><span>ROI Projection</span><strong id="kpiROI">--</strong></div>
              </div>
            </div>
            <label>Run Library<select id="runSelect"></select></label>
            <div style="display:flex; gap:8px; margin-bottom: 10px; flex-wrap: wrap;">
              <button id="loadRunBtn">Load Run</button>
              <button id="latestRunBtn">Latest</button>
              <button id="rerunBtn">Rerun</button>
              <button id="retryFailedBtn">Retry Failed</button>
            </div>
            <div class="section-title" style="margin-top: 10px;">Recent Runs</div>
            <div id="runList" class="run-list"></div>
            <label>Resume last run<input id="resumeLast" type="checkbox" /></label>
            <label>Resume from node<select id="resumeNode"></select></label>
            <label>Run ID<input id="resumeRunId" placeholder="Optional" /></label>
            <label>Uploads<input id="uploadInput" type="file" multiple /></label>
            <div id="uploadStatus" class="helper"></div>
            <label>Generate strategies<select id="generateStrategies">
              <option value="true">Yes</option>
              <option value="false">No</option>
            </select></label>
            <div class="section-title" style="margin-top: 14px;">Filters</div>
            <label>Company Focus<input id="controlCompany" placeholder="Microsoft" /></label>
            <label>Scenario Depth<input id="controlDepth" type="range" min="1" max="10" value="6" /></label>
            <label>Time Horizon<input id="controlHorizon" type="range" min="36" max="120" value="60" /></label>
            <label>Filter Signals<select id="controlSignal"><option>All</option></select></label>
            <label>Filter Scenarios<select id="controlScenario"><option>All</option></select></label>
          </aside>
        </div>

        <div class="section">
          <div class="glass" style="padding: 18px;">
            <div style="display:flex; justify-content: space-between; align-items: center;">
              <div class="section-title">Terminal Lite</div>
              <label class="helper" style="display:flex; gap:6px; align-items:center;">
                <input type="checkbox" id="toggleRawLogs" />
                Show raw logs
              </label>
            </div>
            <div class="tabs" id="logTabs">
              <div class="tab active" data-log="all">All Logs</div>
              <div class="tab" data-log="sentinel">Sentinel</div>
              <div class="tab" data-log="analyst">Analyst</div>
              <div class="tab" data-log="critic">Critic</div>
              <div class="tab" data-log="errors">Errors</div>
            </div>
            <div class="terminal" id="terminal"></div>
          </div>
        </div>
      </section>

      <section class="section hidden" data-view="/intelligence">
        <div class="glass" style="padding: 18px;">
          <div class="section-title">Intelligence Signals</div>
          <div id="signalMeta" class="helper" style="margin-bottom: 10px;"></div>
          <div id="signalFeed" class="cards"></div>
        </div>
      </section>

      <section class="section hidden" data-view="/scenarios">
        <div class="glass" style="padding: 18px;">
          <div class="section-title">Scenario Lab</div>
          <div class="glass" style="padding: 14px; margin-bottom: 16px;">
            <div class="section-title">Axis Cluster EBE</div>
            <div id="axisEbeGraph" class="axis-graph"></div>
          </div>
          <div class="matrix" id="scenarioMatrix" style="margin-bottom: 16px;"></div>
          <div class="cards" id="scenarioCards"></div>
        </div>
      </section>

      <section class="section hidden" data-view="/wind-tunnel">
        <div class="glass" style="padding: 18px;">
          <div class="section-title">Strategy Score Grid</div>
          <div class="matrix" id="scoreMatrix"></div>
          <div class="section-title" style="margin-top: 16px;">Cell Evidence</div>
          <div id="windDetail" class="glass" style="padding: 12px; min-height: 120px;">Select a cell for details.</div>
          <div class="section-title" style="margin-top: 18px;">Comparative Insights</div>
          <div id="insights" class="cards"></div>
          <div class="section-title" style="margin-top: 18px;">Strategy Ranking Summary</div>
          <div class="matrix" id="rankingTable"></div>
        </div>
      </section>

      <section class="section hidden" data-view="/actions">
        <div class="glass" style="padding: 18px;">
          <div class="action-toolbar">
            <div class="section-title">Action Console</div>
            <div class="action-actions">
              <button id="actionGenerateBtn">Generate Actions</button>
              <button id="actionAddBtn">Add Action</button>
              <button id="actionEditBtn">Edit</button>
              <button class="primary" id="actionSaveBtn">Save</button>
            </div>
          </div>
          <div id="actionStatus" class="helper"></div>
          <div class="cards action-board" id="actionBoard"></div>
        </div>
      </section>

      <section class="section hidden" data-view="/chat">
        <div class="glass" style="padding: 18px;">
          <div class="section-title">Scenario Advisor</div>
          <div class="helper" style="margin-bottom: 12px;">
            Ask questions grounded in the run artifacts + vector database. The assistant will only use run data.
          </div>
          <div class="chat-panel">
            <div id="chatMessages" class="chat-messages"></div>
            <div class="chat-input">
              <textarea id="chatInput" placeholder="Ask about scenarios, strategies, market signals, or risks..."></textarea>
              <button id="chatSend" class="primary">Ask</button>
            </div>
            <div id="chatStatus" class="helper"></div>
          </div>
        </div>
      </section>

    </div>

    <div class="modal hidden" id="accessModal">
      <div class="glass modal-card">
        <div class="section-title">API Access</div>
        <label>API Base URL<input id="apiBaseInput" placeholder="http://localhost:8502" /></label>
        <label>API Key<input id="apiKeyInput" type="password" placeholder="Enter API key" /></label>
        <div class="helper">Stored locally in your browser. Required if auth is enabled.</div>
        <div class="section-title" style="margin-top: 14px;">Environment</div>
        <pre id="envStatus" class="helper" style="white-space: pre-wrap; margin: 6px 0 0;"></pre>
        <div class="modal-actions">
          <button id="closeAccess">Cancel</button>
          <button class="primary" id="saveAccess">Save</button>
        </div>
      </div>
    </div>

    <div class="modal hidden" id="configModal">
      <div class="glass modal-card">
        <div class="section-title">Admin Overrides (advanced)</div>
        <div class="helper" style="margin: 6px 0 12px;">
          Requires an admin API key. These settings override runtime configuration for all runs.
        </div>
        <div class="config-label">Override JSON</div>
        <textarea id="configEditor" rows="10" class="config-editor"></textarea>
        <div id="configStatus" class="helper"></div>
        <div class="modal-actions">
          <button id="closeConfig">Close</button>
          <button class="primary" id="saveConfig">Save Config</button>
        </div>
      </div>
    </div>

    <div class="modal hidden" id="helpModal">
      <div class="glass modal-card">
        <div class="section-title">ScenarioOps Help</div>
        <div class="helper" style="margin-top: 8px;">
          <p><strong>What is scenario planning?</strong> A structured way to explore multiple plausible futures so leaders can stress-test strategy.</p>
          <p><strong>Uncertainty axes</strong> define the two most critical unknowns that shape the scenario matrix.</p>
          <p><strong>Wind tunneling</strong> evaluates strategies against each scenario to find robust options.</p>
          <p><strong>Runs</strong> are full scenario pipelines. Completed runs are read-only; use Rerun to refresh.</p>
        </div>
        <div class="modal-actions">
          <button id="closeHelp">Close</button>
        </div>
      </div>
    </div>

    <script>
      const state = {
        runId: null,
        viewModel: null,
        nodeEvents: [],
        normalization: [],
        logs: [],
        runs: [],
        runLabels: {},
        latestLinks: [],
        uploadedDocs: [],
        chatMessages: [],
        connected: false,
        lastEventAt: null,
        launchingRunId: null,
        actionConsole: null,
        actionEditMode: false,
        actionDirty: false,
        readOnly: false,
      };

      const defaultNodes = [
        { id: "charter", label: "Charter" },
        { id: "focal_issue", label: "Focal Issue" },
        { id: "company_profile", label: "Company Profile" },
        { id: "ingest_docs", label: "Ingest Docs" },
        { id: "retrieval_real", label: "Retrieval Real" },
        { id: "forces", label: "Forces" },
        { id: "ebe_rank", label: "EBE Rank" },
        { id: "clusters", label: "Clusters" },
        { id: "uncertainty_axes", label: "Uncertainty Axes" },
        { id: "scenarios", label: "Scenarios" },
        { id: "scenario_media", label: "Scenario Media" },
        { id: "strategies", label: "Strategies" },
        { id: "wind_tunnel", label: "Wind Tunnel" },
        { id: "auditor", label: "Auditor" },
      ];

      const resumeSteps = [
        "charter",
        "focal_issue",
        "company_profile",
        "ingest_docs",
        "retrieval_real",
        "forces",
        "ebe_rank",
        "clusters",
        "uncertainty_axes",
        "scenarios",
        "scenario_media",
        "strategies",
        "wind_tunnel",
        "auditor",
      ];

      const stageMap = {
        charter: ["charter"],
        focal_issue: ["focal_issue"],
        company_profile: ["company_profile"],
        ingest_docs: ["ingest_docs"],
        retrieval_real: ["retrieval_real"],
        forces: ["forces"],
        ebe_rank: ["ebe_rank"],
        clusters: ["clusters"],
        uncertainty_axes: ["uncertainty_axes"],
        scenarios: ["scenarios"],
        scenario_media: ["scenario_media"],
        strategies: ["strategies"],
        wind_tunnel: ["wind_tunnel"],
        auditor: ["auditor"],
      };

      function apiBase() {
        const base = localStorage.getItem("scenarioops_api_base") || "";
        return base.endsWith("/") ? base.slice(0, -1) : base;
      }

      function apiHeaders() {
        const key = localStorage.getItem("scenarioops_api_key");
        return key ? { "X-Api-Key": key } : {};
      }

      async function fetchJson(path, options = {}) {
        const url = path.startsWith("http") ? path : `${apiBase()}${path}`;
        const method = (options.method || "GET").toUpperCase();
        const useAuth = options.useAuth ?? (method !== "GET");
        const res = await fetch(url, {
          ...options,
          headers: { ...(options.headers || {}), ...(useAuth ? apiHeaders() : {}) },
        });
        if (!res.ok) {
          const text = await res.text();
          const error = new Error(text || res.statusText);
          error.status = res.status;
          throw error;
        }
        const contentType = res.headers.get("content-type") || "";
        if (contentType.includes("application/json")) {
          return res.json();
        }
        return res.text();
      }

      async function fetchLatest() {
        return fetchJson("/latest");
      }

      async function fetchHealth() {
        return fetchJson("/health", { useAuth: true });
      }

      async function fetchRuns() {
        return fetchJson("/runs");
      }

      async function deleteRun(runId) {
        return fetchJson(`/runs/${runId}`, { method: "DELETE" });
      }

      async function fetchArtifact(runId, name) {
        return fetchJson(`/artifact/${runId}/${name}`);
      }

      async function fetchNodeEvents(runId) {
        return fetchJson(`/run/${runId}/node_events`).then((d) => d.entries || []);
      }

      async function fetchNormalization(runId) {
        return fetchJson(`/run/${runId}/normalization`).then((d) => d.entries || []);
      }

      async function fetchActionConsole(runId) {
        return fetchJson(`/action-console/${runId}`);
      }

      async function generateActionConsole(runId) {
        return fetchJson(`/action-console/${runId}/generate`, { method: "POST" });
      }

      async function saveActionConsole(runId, payload) {
        return fetchJson(`/action-console/${runId}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
      }

      async function fetchConfig() {
        return fetchJson("/config", { useAuth: true });
      }

      async function saveConfig(settings) {
        return fetchJson("/config", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ settings }),
        });
      }

      async function uploadFiles(files) {
        const form = new FormData();
        Array.from(files).forEach((file) => form.append("files", file));
        return fetchJson("/upload", { method: "POST", body: form });
      }

      function _statusLabel(connected) {
        if (!connected) return "OFFLINE";
        if (state.launchingRunId) return "LAUNCHING";
        const runStatus = deriveRunStatus().status;
        if (runStatus) return String(runStatus).toUpperCase();
        if (state.runId) return "LOADED";
        return "CONNECTED";
      }

        function _statusDetail(connected) {
          const baseLabel = apiBase() || window.location.origin;
          if (!connected) {
            return `Unable to reach API at ${baseLabel}.`;
          }
          if (state.launchingRunId) {
            return `Run ${state.launchingRunId} is launching.`;
          }
          if (state.runId) {
            const context = state.viewModel ? resolveContext(state.viewModel) : null;
            const label = context ? formatRunLabel(context) : state.runId;
            const age = state.lastEventAt ? ` â€¢ Last update ${formatAge(state.lastEventAt)}` : "";
            return `Run ${label}${age}`;
          }
          return `Connected to ${baseLabel}.`;
        }

        function setStatus(connected, message, detail) {
          state.connected = connected;
          const pulse = document.getElementById("pulseIndicator");
          pulse.classList.toggle("off", !connected);
          const label = message || _statusLabel(connected);
          document.getElementById("statusText").textContent = label;
          document.getElementById("statusDetail").textContent = detail || _statusDetail(connected);
        }

        async function refreshApiKeyStatus() {
          const label = document.getElementById("apiKeyStatus");
          const env = document.getElementById("envStatus");
          if (!label) return;
          try {
            const health = await fetchHealth();
            const source = health?.api_key_source || "none";
            label.textContent = `API: Connected (source: ${source})`;
            if (env) {
              const runsLocation = health?.runs_location || health?.runs_dir || "unknown";
              const vectorMode = health?.vector_store || "unknown";
              const vectorScope = health?.vector_scope || "global";
              const vectorLocation = health?.vector_location || "unknown";
              env.textContent = [
                `Storage: ${health?.storage_backend || "unknown"}`,
                `Runs: ${runsLocation}`,
                `Vector: ${vectorMode} (${vectorScope})`,
                `Vector path: ${vectorLocation}`,
              ].join("\n");
            }
          } catch (err) {
            label.textContent = "API: Unknown";
            if (env) {
              env.textContent = "Environment unavailable.";
            }
          }
        }

      function applyReadOnlyState() {
          const runStatusValue = String(state.viewModel?.run_meta?.status || "").toUpperCase();
          const isFailed = runStatusValue === "FAIL" || runStatusValue === "FAILED";
          const isReadOnly = Boolean(state.readOnly);
          const status = document.getElementById("runStatus");
          if (status && isReadOnly) {
            status.textContent = "Read-only mode: completed run.";
          }
          if (status && isFailed) {
            status.textContent = "Run failed. You can retry or resume from the failed node.";
          }
          [
            "uploadInput",
            "actionEditBtn",
            "actionSaveBtn",
            "actionGenerateBtn",
          ].forEach((id) => {
            const el = document.getElementById(id);
            if (!el) return;
            el.disabled = isReadOnly;
          });
          const retryBtn = document.getElementById("retryFailedBtn");
          if (retryBtn) {
            retryBtn.disabled = isReadOnly && !isFailed;
          }
        }

      function showEmptyState(show) {
        const emptyState = document.getElementById("emptyState");
        emptyState.style.display = show ? "block" : "none";
      }

      function _pad2(value) {
        return String(value).padStart(2, "0");
      }

      function generateRunId() {
        const now = new Date();
        return [
          now.getUTCFullYear(),
          _pad2(now.getUTCMonth() + 1),
          _pad2(now.getUTCDate()),
          _pad2(now.getUTCHours()),
          _pad2(now.getUTCMinutes()),
          _pad2(now.getUTCSeconds()),
        ].join("");
      }

        function truncateText(value, limit) {
          if (!value) return "";
          if (value.length <= limit) return value;
          return `${value.slice(0, Math.max(0, limit - 1)).trim()}â€¦`;
        }

        function formatAge(date) {
          if (!date) return "";
          const deltaMs = Date.now() - date.getTime();
          if (deltaMs < 60000) return "just now";
          const minutes = Math.floor(deltaMs / 60000);
          if (minutes < 60) return `${minutes}m ago`;
          const hours = Math.floor(minutes / 60);
          if (hours < 24) return `${hours}h ago`;
          const days = Math.floor(hours / 24);
          return `${days}d ago`;
        }

        function formatStepLabel(step) {
          return String(step || "")
            .replace(/_/g, " ")
            .replace(/\b\w/g, (match) => match.toUpperCase());
        }

      function escapeHtml(value) {
        if (value === null || value === undefined) return "";
        return String(value)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/\"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      function formatRunLabel(context) {
        if (!context) return "Run";
        const company = context.company || "Company";
        const horizon = context.horizon || 60;
        const geography = context.geography || "Global";
        return `${company} â€¢ SP${horizon} â€¢ ${geography}`;
      }

      const STALL_MINUTES = 10;

      function _parseTimestamp(value) {
        if (!value) return null;
        const parsed = Date.parse(value);
        if (Number.isNaN(parsed)) return null;
        return new Date(parsed);
      }

      function _lastNodeEvent() {
        const events = Array.isArray(state.nodeEvents) ? state.nodeEvents : [];
        let last = null;
        let lastTime = null;
        events.forEach((entry) => {
          const ts = _parseTimestamp(entry.timestamp);
          if (!ts) return;
          if (!lastTime || ts > lastTime) {
            lastTime = ts;
            last = entry;
          }
        });
        return { entry: last, timestamp: lastTime };
      }

      function _runLooksComplete() {
        if (!state.viewModel) return false;
        const wind = state.viewModel?.wind_tunnel_evaluations_v2?.evaluations || [];
        if (wind.length) return true;
        const strategies = state.viewModel?.strategies || [];
        if (strategies.length) return true;
        const scenarios = state.viewModel?.scenarios || [];
        const axes = state.viewModel?.uncertainty_axes || [];
        return scenarios.length >= 4 && axes.length >= 2;
      }

      function deriveRunStatus() {
        if (state.launchingRunId) {
          return { status: "LAUNCHING", lastEvent: null, current: null };
        }
        const meta = state.viewModel?.run_meta || {};
        const nodeStatus = meta.node_status || {};
        const nodeEntries = Object.entries(nodeStatus).map(([node, entry]) => ({
          node,
          entry: entry || {},
          updated_at: entry?.updated_at ? new Date(entry.updated_at) : null,
        }));
        if (nodeEntries.length) {
          const statuses = nodeEntries.map((item) => String(item.entry.status || "").toUpperCase());
          const hasFail = statuses.some((status) => status.includes("FAIL"));
          const hasRunning = statuses.some((status) => status.includes("RUN"));
          const last = nodeEntries
            .filter((item) => item.updated_at)
            .sort((a, b) => b.updated_at - a.updated_at)[0];
          if (hasFail) {
            return { status: "FAIL", lastEvent: last?.updated_at || null, current: last?.entry || null };
          }
          if (hasRunning) {
            return { status: "RUNNING", lastEvent: last?.updated_at || null, current: last?.entry || null };
          }
          if (String(meta.status || "").toUpperCase().includes("COMPLETE")) {
            return { status: "OK", lastEvent: last?.updated_at || null, current: last?.entry || null };
          }
        }
        const events = Array.isArray(state.nodeEvents) ? state.nodeEvents : [];
        if (!events.length) {
          return { status: state.runId ? "PENDING" : "IDLE", lastEvent: null, current: null };
        }
        const hasFail = events.some((entry) => String(entry.status || "").toUpperCase().includes("FAIL"));
        const last = _lastNodeEvent();
        if (hasFail) {
          return { status: "FAIL", lastEvent: last.timestamp, current: last.entry };
        }
        if (_runLooksComplete()) {
          return { status: "OK", lastEvent: last.timestamp, current: last.entry };
        }
        if (last.timestamp) {
          const minutes = (Date.now() - last.timestamp.getTime()) / 60000;
          if (minutes > STALL_MINUTES) {
            return { status: "STALLED", lastEvent: last.timestamp, current: last.entry };
          }
        }
        return { status: "RUNNING", lastEvent: last.timestamp, current: last.entry };
      }

      function latestFailedNode() {
        const events = Array.isArray(state.nodeEvents) ? state.nodeEvents : [];
        for (let i = events.length - 1; i >= 0; i -= 1) {
          const entry = events[i] || {};
          const status = String(entry.status || "").toUpperCase();
          if (status.includes("FAIL") || entry.error) {
            return String(entry.node || entry.step || entry.id || "");
          }
        }
        return "";
      }

        function _decodeHtmlEntities(value) {
          if (!value) return "";
          const helper = document.createElement("textarea");
          helper.innerHTML = value;
          return helper.value;
        }

        function sanitizeChatText(text) {
          if (text === null || text === undefined) return "";
          let cleaned = Array.isArray(text) ? text.join("") : String(text);
          cleaned = _decodeHtmlEntities(_decodeHtmlEntities(cleaned));
          cleaned = cleaned.replace(/<[^>]+>/g, "");
          return cleaned;
        }

        function formatAdvisorHtml(text) {
          if (!text) return "";
          const safe = escapeHtml(sanitizeChatText(text));
        const lines = safe.split("\n");
        let html = "";
        let inList = false;
        const closeList = () => {
          if (inList) {
            html += "</ul>";
            inList = false;
          }
        };
        const inlineFormat = (value) =>
          value
            .replace(/\\*\\*(.+?)\\*\\*/g, "<strong>$1</strong>")
            .replace(/`([^`]+)`/g, "<code>$1</code>")
            .replace(/\\*(.+?)\\*/g, "<em>$1</em>");
        lines.forEach((line) => {
          if (/^\\s*[-*]\\s+/.test(line)) {
            if (!inList) {
              html += "<ul>";
              inList = true;
            }
            const item = line.replace(/^\\s*[-*]\\s+/, "");
            html += `<li>${inlineFormat(item)}</li>`;
            return;
          }
          closeList();
          if (/^\\s*#{1,3}\\s+/.test(line)) {
            html += `<div class="chat-heading">${inlineFormat(line.replace(/^\\s*#{1,3}\\s+/, ""))}</div>`;
            return;
          }
          if (!line.trim()) {
            html += `<div class="chat-spacer"></div>`;
            return;
          }
          html += `<div class="chat-paragraph">${inlineFormat(line)}</div>`;
        });
        closeList();
        return html;
      }

      function resolveContext(viewModel) {
        const prompt = viewModel?.prompt_manifest || {};
        const scope = viewModel?.focal_issue?.scope || {};
        const geography =
          scope.geography ||
          viewModel?.focal_issue?.geography ||
          prompt.geography ||
          viewModel?.company_profile?.geography ||
          "Global";
        const horizon =
          scope.time_horizon_months ||
          viewModel?.focal_issue?.time_horizon_months ||
          prompt.horizon_months ||
          60;
        const company =
          viewModel?.company_profile?.company_name ||
          prompt.company_name ||
          viewModel?.charter?.title ||
          "Company";
        return { company, geography, horizon };
      }

      function updateContext(viewModel, runId) {
        const ribbon = document.getElementById("contextRibbon");
        ribbon.innerHTML = "";
        if (!viewModel || !runId) {
          const emptyItems = ["No run loaded", "Select a run", "â€”"];
          emptyItems.forEach((item) => {
            const pill = document.createElement("div");
            pill.className = "context-pill";
            pill.textContent = item;
            ribbon.appendChild(pill);
          });
          document.getElementById("runState").textContent = "Idle";
          return;
        }
        const context = resolveContext(viewModel);
        const items = [
          context.geography || "Global",
          `${context.horizon || 60} Months`,
          context.company || "Company",
        ];
        items.forEach((item) => {
          const pill = document.createElement("div");
          pill.className = "context-pill";
          pill.textContent = item;
          ribbon.appendChild(pill);
        });
        const status = deriveRunStatus().status || "idle";
        const runLabel = formatRunLabel(context);
        document.getElementById("runState").textContent = runId ? `${status.toUpperCase()} - ${runLabel}` : "Idle";
      }

      function updateContextDraft(runId) {
        const ribbon = document.getElementById("contextRibbon");
        ribbon.innerHTML = "";
        const geography = draft.geography || (draft.scope === "world" ? "Global" : "Global");
        const horizon = draft.horizon || 60;
        const company = draft.company || "Company";
        const items = [geography, `${horizon} Months`, company];
        items.forEach((item) => {
          const pill = document.createElement("div");
          pill.className = "context-pill";
          pill.textContent = item;
          ribbon.appendChild(pill);
        });
        document.getElementById("runState").textContent = runId ? `LAUNCHING - ${formatRunLabel({ company, geography, horizon })}` : "Launching";
      }

      function renderCompanyCards() {
        const companyProfile = state.viewModel?.company_profile || {};
        const focus = state.viewModel?.focal_issue || {};
        const context = resolveContext(state.viewModel);
        const companyText = companyProfile.summary || context.company || "Awaiting data.";
        const focusText = focus.focal_issue || focus.purpose || state.viewModel?.charter?.purpose || "Awaiting data.";
        document.getElementById("companyOverview").textContent = state.viewModel ? companyText : "Awaiting data.";
        document.getElementById("strategicFocus").textContent = state.viewModel ? focusText : "Awaiting data.";
        const name = context.company || "Company";
        const market =
          companyProfile.industry ||
          companyProfile.market ||
          companyProfile.sector ||
          (Array.isArray(companyProfile.tags) ? companyProfile.tags.join(", ") : "") ||
          "Market";
        const region = context.geography || "Global";
        const initials = name
          .split(" ")
          .filter(Boolean)
          .slice(0, 2)
          .map((word) => word[0].toUpperCase())
          .join("");
        const logo = document.getElementById("companyLogo");
        const nameEl = document.getElementById("companyName");
        const marketEl = document.getElementById("companyMarket");
        const summaryEl = document.getElementById("companySummary");
        const metaEl = document.getElementById("runMeta");
        if (logo) logo.textContent = initials || "SO";
        if (nameEl) nameEl.textContent = state.viewModel ? name : "Company";
        if (marketEl) marketEl.textContent = state.viewModel ? `${market} â€¢ ${region}` : "Market â€¢ Region";
        if (summaryEl) summaryEl.textContent = state.viewModel ? (companyProfile.summary || companyProfile.description || "Awaiting profile data.") : "Awaiting profile data.";
        if (metaEl) {
          if (!state.viewModel) {
            metaEl.textContent = "No run loaded.";
          } else {
            const runConfig = state.viewModel?.run_meta?.run_config || {};
            const settings = runConfig.settings || {};
            const mode = settings.mode || "live";
            const provider = settings.llm_provider || "gemini";
            const allowWeb = settings.allow_web ? "web" : "no-web";
            const simulated = settings.simulate_evidence ? "simulated" : "real";
            metaEl.textContent = `Run ${state.runId} â€¢ ${mode}/${provider} â€¢ ${allowWeb} â€¢ ${simulated}`;
          }
        }
      }

      function renderKPIs() {
        if (!state.viewModel) {
          document.getElementById("kpiVolatility").textContent = "--";
          document.getElementById("kpiConfidence").textContent = "--";
          document.getElementById("kpiROI").textContent = "--";
          return;
        }
        const scenarios = state.viewModel?.scenarios || [];
        const rankings = state.viewModel?.wind_tunnel_evaluations_v2?.rankings || {};
        const overall = (rankings.overall || [])[0];
        const evals = state.viewModel?.wind_tunnel_evaluations_v2?.evaluations || [];
        const avgScore = evals.length
          ? (evals.reduce((sum, e) => sum + (e.score_0_100 || 0), 0) / evals.length).toFixed(1)
          : "--";
        document.getElementById("kpiVolatility").textContent = `${scenarios.length} scenarios`;
        document.getElementById("kpiConfidence").textContent = overall ? `${overall.overall_score}` : avgScore;
        document.getElementById("kpiROI").textContent = overall ? `Robustness ${overall.robustness_index}` : "--";
      }

      function renderBriefing() {
        const el = document.getElementById("briefing");
        el.classList.remove("ghost");
        if (!state.viewModel) {
          el.innerHTML = "<div class=\"helper\">No run loaded. Launch or load a run to see briefing.</div>";
          return;
        }
        const daily = state.viewModel?.daily_brief_md;
        if (daily) {
          const lines = daily.split("\n").filter((line) => line.trim()).slice(0, 3);
          el.innerHTML = `<ul>${lines.map((line) => `<li>${line.replace(/^[-*]\\s*/, "")}</li>`).join("")}</ul>`;
          return;
        }
        const focal = state.viewModel?.focal_issue?.focal_issue || "Briefing pending.";
        el.innerHTML = `<ul><li>${focal}</li><li>${state.viewModel?.charter?.purpose || ""}</li><li>Next: review wind tunnel recommendations.</li></ul>`;
      }

      function renderWorkflow() {
        const map = document.getElementById("workflowNodes");
        map.innerHTML = "";
        const enabledByPack = new Set(defaultNodes.map((node) => node.id));
        const capabilityNodes = (state.viewModel?.run_meta?.capabilities?.nodes || [])
          .map((node) => String(node).toLowerCase());
        const enabledByCapability = new Set(capabilityNodes);
        const runStatus = String(state.viewModel?.run_meta?.status || "").toUpperCase();
        const runComplete = runStatus === "OK" || runStatus === "FAIL";
        const enabledNodes = new Set(enabledByPack);
        if (enabledByCapability.size) {
          [...enabledNodes].forEach((node) => {
            if (!enabledByCapability.has(node)) enabledNodes.delete(node);
          });
        }
        if (!state.viewModel) {
          defaultNodes.forEach((node) => {
            const div = document.createElement("div");
            div.className = "node";
            if (!enabledNodes.has(node.id)) div.classList.add("disabled");
            div.textContent = node.label;
            map.appendChild(div);
          });
          return;
        }
        defaultNodes.forEach((node) => {
          const steps = stageMap[node.id] || [];
          const nodeStatusMap = state.viewModel?.run_meta?.node_status || {};
          const nodeMeta = nodeStatusMap[node.id] || null;
          const entries = state.nodeEvents.filter((e) => steps.includes((e.node || "").toLowerCase()));
          const statuses = entries.map((e) => String(e.status || "").toUpperCase());
          let stageStatus = "PENDING";
          if (nodeMeta) {
            const metaStatus = String(nodeMeta.status || "").toUpperCase();
            if (metaStatus.includes("FAIL")) {
              stageStatus = "FAIL";
            } else if (metaStatus.includes("RUN")) {
              stageStatus = "RUNNING";
            } else if (metaStatus.includes("OK") || metaStatus.includes("SKIPPED") || metaStatus.includes("HYDRATED")) {
              stageStatus = "OK";
            }
          } else if (statuses.some((status) => status.includes("FAIL"))) {
            stageStatus = "FAIL";
          } else if (statuses.some((status) => status.includes("RUN"))) {
            stageStatus = "RUNNING";
          } else if (steps.length && entries.length === steps.length && statuses.every((status) => status.includes("OK") || status.includes("SKIPPED"))) {
            stageStatus = "OK";
          } else if (entries.length) {
            stageStatus = runComplete ? "OK" : "RUNNING";
          }
          if (runComplete && entries.length === 0 && stageStatus === "PENDING") {
            stageStatus = "SKIPPED";
          }
          const div = document.createElement("div");
          const isEnabled = enabledNodes.has(node.id);
          div.className = "node";
          if (!isEnabled) div.classList.add("disabled");
          if (stageStatus === "RUNNING") div.classList.add("running");
          if (stageStatus === "FAIL") div.classList.add("error");
          if (stageStatus === "OK") div.classList.add("success");
          div.textContent = node.label;
          if (isEnabled) {
            const durationSeconds = entries.reduce(
              (total, entry) => total + (entry.duration_seconds || 0),
              0
            );
            const detailMessage = steps.length
              ? `Steps: ${steps.join(", ")} (${entries.length}/${steps.length})`
              : "No steps mapped.";
            div.addEventListener("click", () =>
              renderNodeDetail({
                node: node.id,
                status: stageStatus,
                message: detailMessage,
                duration_seconds: nodeMeta?.duration_seconds ?? durationSeconds,
                attempt: nodeMeta?.attempt,
              })
            );
          }
          map.appendChild(div);
        });
      }

      function renderNodeDetail(entry) {
        const detail = document.getElementById("nodeDetailBody");
        detail.classList.remove("ghost");
        if (!entry) {
          detail.textContent = "Select a node to view details.";
          return;
        }
        const history = state.nodeEvents
          .filter((e) => String(e.node || "").toLowerCase() === String(entry.node || "").toLowerCase())
          .slice(-5)
          .map((e, idx) => {
            const status = String(e.status || "OK");
            const ts = e.timestamp ? formatDate(e.timestamp) : "unknown";
            return `<div>${idx + 1}. ${status} â€¢ ${ts}</div>`;
          })
          .join("");
        detail.innerHTML = `
          <div><strong>${entry.node || "node"}</strong></div>
          <div>Status: ${entry.status || "OK"}</div>
          <div>Duration: ${entry.duration_seconds || 0}s</div>
          ${entry.attempt ? `<div>Attempts: ${entry.attempt}</div>` : ""}
          <div>Notes: ${entry.message || entry.detail || "None"}</div>
          ${history ? `<div style="margin-top:8px;"><div class="helper">Recent attempts</div>${history}</div>` : ""}
        `;
      }

      function renderRunProgress() {
          const el = document.getElementById("runProgress");
          if (!el) return;
          if (!state.viewModel) {
            el.textContent = "No run loaded.";
            return;
          }
          const events = state.nodeEvents || [];
          const completed = events.filter((e) => String(e.status || "").toUpperCase().includes("OK")).length;
          const failed = events.filter((e) => String(e.status || "").toUpperCase().includes("FAIL")).length;
          const derived = deriveRunStatus();
          const status = derived.status || _statusLabel(state.connected);
          const current = derived.current
            ? `${derived.current.node || "node"} (${derived.current.status || "OK"})`
            : state.launchingRunId
            ? "Launching"
            : "Pending";
          const lastUpdate = derived.lastEvent ? ` â€¢ Last update ${formatAge(derived.lastEvent)}` : "";
          el.textContent = `Status: ${status} â€¢ Current: ${current} â€¢ Completed: ${completed} â€¢ Failed: ${failed}${lastUpdate}`;
        }

      function renderArtifacts() {
        const container = document.getElementById("artifactList");
        container.innerHTML = "";
        if (!state.viewModel) {
          container.innerHTML = "<div class=\"helper\">No run loaded.</div>";
          return;
        }
        if (!state.latestLinks.length) {
          container.innerHTML = `<div class="helper">Artifacts will appear after a run completes.</div>`;
          return;
        }
        state.latestLinks.slice(0, 8).forEach((item) => {
          const div = document.createElement("div");
          div.className = "run-step";
          div.innerHTML = `<span>${item}</span>`;
          container.appendChild(div);
        });
      }

      function buildLogLines() {
        const includeRaw = document.getElementById("toggleRawLogs").checked;
        const lines = [];
        state.nodeEvents.forEach((entry) => {
          lines.push({ text: `${entry.node || "node"} :: ${entry.status || "OK"}`, tag: entry.node || "node" });
        });
        if (includeRaw) {
          state.normalization.forEach((entry) => {
            lines.push({ text: `normalize :: ${entry.operation || ""}`, tag: "raw" });
          });
        }
        return lines;
      }

      function renderTerminal(logs) {
        const terminal = document.getElementById("terminal");
        if (!state.viewModel) {
          terminal.innerHTML = "<div class=\"helper\">No run loaded.</div>";
          return;
        }
        if (!logs.length) {
          terminal.innerHTML = "<div class=\"helper\">No logs yet. Launch a run to see live activity.</div>";
          return;
        }
        terminal.innerHTML = logs.map((line) => `<div>${line.text}</div>`).join("");
      }

      function renderSignalFeed() {
        const feed = document.getElementById("signalFeed");
        const meta = document.getElementById("signalMeta");
        feed.innerHTML = "";
        if (meta) meta.textContent = "";
        if (!state.viewModel) {
          feed.innerHTML = `<div class="helper">No run loaded.</div>`;
          return;
        }
        const forces = state.viewModel?.forces || [];
        const ranked = state.viewModel?.forces_ranked?.forces || [];
        const driving = state.viewModel?.driving_forces || [];
        const drivers = state.viewModel?.drivers || [];
        let items = [];
        let sourceLabel = "";
        if (forces.length) {
          items = forces;
          sourceLabel = "Forces";
        } else if (ranked.length) {
          items = ranked;
          sourceLabel = "Ranked forces";
        } else if (driving.length) {
          items = driving;
          sourceLabel = "Driving forces";
        } else {
          items = drivers;
          sourceLabel = "Signals";
        }
        if (!items.length) {
          feed.innerHTML = `<div class="helper">No intelligence signals yet.</div>`;
          return;
        }
        if (meta) meta.textContent = `${sourceLabel} â€¢ ${items.length} items`;
        const rankedByKey = new Map();
        ranked.forEach((entry) => {
          const key = entry.force_id || entry.id || entry.label || entry.name;
          if (key) rankedByKey.set(String(key), entry);
        });
        items.forEach((item) => {
          const card = document.createElement("div");
          card.className = "glass card";
          const label = item.label || item.name || item.force || item.title || "Signal";
          const domain = item.domain || item.category || "Signal";
          const summary = truncateText(
            item.mechanism || item.description || item.why_it_matters || item.rationale || item.summary || "",
            240
          );
          const evidenceCount = Array.isArray(item.evidence_unit_ids)
            ? item.evidence_unit_ids.length
            : Array.isArray(item.citations)
            ? item.citations.length
            : Array.isArray(item.signals)
            ? item.signals.length
            : 0;
          const confidence =
            typeof item.confidence === "number" ? `${Math.round(item.confidence * 100)}%` : "";
          const key = item.force_id || item.id || item.label || item.name || "";
          const rankedEntry = rankedByKey.get(String(key));
          const ebeScore = rankedEntry?.ebe_score;
          const metaParts = [];
          if (item.layer) metaParts.push(item.layer);
          if (confidence) metaParts.push(`confidence ${confidence}`);
          if (ebeScore !== undefined) metaParts.push(`EBE ${ebeScore}`);
          if (evidenceCount) metaParts.push(`${evidenceCount} signals`);
          const metaLine = metaParts.join(" â€¢ ");
          card.innerHTML = `
            <div class="tag">${domain}</div>
            <h4>${label}</h4>
            <p>${summary || "Details pending."}</p>
            ${metaLine ? `<div class="helper">${metaLine}</div>` : ""}
          `;
          feed.appendChild(card);
        });
      }

      function renderScenarioMatrix() {
        const matrix = document.getElementById("scenarioMatrix");
        const scenarios = state.viewModel?.scenarios || [];
        const axes = state.viewModel?.uncertainty_axes || [];
        if (!state.viewModel) {
          matrix.innerHTML = `<div class="helper">No run loaded.</div>`;
          return;
        }
        if (axes.length < 2 || scenarios.length < 4) {
          matrix.innerHTML = `<div class="helper">Scenario matrix will appear after axes are generated.</div>`;
          return;
        }
        const table = document.createElement("table");
        const header = document.createElement("tr");
        const axis0Label = axes[0].axis_name || "Axis 1";
        const axis1Label = axes[1].axis_name || "Axis 2";
        header.innerHTML = `<th></th><th title="Axis: ${escapeHtml(axis0Label)}">${axes[0].high || "High"}</th><th title="Axis: ${escapeHtml(axis0Label)}">${axes[0].low || "Low"}</th>`;
        table.appendChild(header);
        const rows = [
          { label: axes[1].high || "High", scenarios: [scenarios[0], scenarios[1]] },
          { label: axes[1].low || "Low", scenarios: [scenarios[2], scenarios[3]] },
        ];
        rows.forEach((row) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<th title="Axis: ${escapeHtml(axis1Label)}">${row.label}</th>${row.scenarios.map((s) => `<td>${s?.name || s?.id || "Scenario"}</td>`).join("")}`;
          table.appendChild(tr);
        });
        matrix.innerHTML = "";
        matrix.appendChild(table);
      }

      function renderAxisEbeGraph() {
        const container = document.getElementById("axisEbeGraph");
        if (!container) return;
        container.innerHTML = "";
        if (!state.viewModel) {
          container.innerHTML = `<div class="helper">No run loaded.</div>`;
          return;
        }
        const clusters = Array.isArray(state.viewModel?.clusters) ? state.viewModel.clusters : [];
        const axes = Array.isArray(state.viewModel?.uncertainty_axes) ? state.viewModel.uncertainty_axes : [];
        const forces = state.viewModel?.forces_ranked?.forces || [];
        if (!clusters.length || !axes.length || !forces.length) {
          container.innerHTML = `<div class="helper">Axis cluster graph will appear after clusters, axes, and EBE ranks are generated.</div>`;
          return;
        }

        const ebeByForce = new Map();
        forces.forEach((force) => {
          const id = force.force_id || force.id;
          if (!id) return;
          ebeByForce.set(String(id), Number(force.ebe_score || 0));
        });

        const clusterTotals = new Map();
        clusters.forEach((cluster) => {
          const ids = Array.isArray(cluster.force_ids) ? cluster.force_ids : [];
          const total = ids.reduce((sum, forceId) => sum + (ebeByForce.get(String(forceId)) || 0), 0);
          clusterTotals.set(String(cluster.cluster_id || cluster.id), {
            total,
            label: cluster.cluster_label || cluster.centroid_summary || "Cluster",
          });
        });

        axes.slice(0, 3).forEach((axis) => {
          const axisId = axis.axis_id || axis.id || "axis";
          const axisName = axis.axis_name || "Axis";
          const poles = `${axis.pole_a || "A"} â†” ${axis.pole_b || "B"}`;
          const clusterIds = axis.tension_basis?.cluster_ids || [];
          const entries = clusterIds
            .map((clusterId) => {
              const entry = clusterTotals.get(String(clusterId));
              if (!entry) return null;
              return { id: clusterId, label: entry.label, total: entry.total };
            })
            .filter(Boolean);
          if (!entries.length) return;
          const maxTotal = Math.max(...entries.map((entry) => entry.total), 1);
          const block = document.createElement("div");
          block.className = "axis-block";
          block.innerHTML = `
            <div class="axis-title">${escapeHtml(axisName)}</div>
            <div class="axis-sub">${escapeHtml(poles)}</div>
            <div class="axis-bars">
              ${entries
                .map((entry) => {
                  const width = Math.max(20, Math.round((entry.total / maxTotal) * 100));
                  return `
                    <div class="axis-bar" style="width: ${width}%">
                      <span>${escapeHtml(entry.label)}</span>
                      <span class="axis-score">EBE ${entry.total.toFixed(1)}</span>
                    </div>
                  `;
                })
                .join("")}
            </div>
          `;
          container.appendChild(block);
        });
      }

      function resolveScenarioImage(runId, scenario) {
        const imagePath = scenario?.image_url || scenario?.image || scenario?.image_artifact_path || "";
        if (!imagePath) return "";
        if (imagePath.startsWith("http")) return imagePath;
        const fileName = imagePath.split("/").pop();
        if (!fileName) return "";
        const base = apiBase();
        const prefix = base ? base : "";
        return `${prefix}/artifact/${runId}/image/${encodeURIComponent(fileName)}`;
      }

      function renderScenarioCards() {
        const container = document.getElementById("scenarioCards");
        container.innerHTML = "";
        if (!state.viewModel) {
          container.innerHTML = `<div class="helper">No run loaded.</div>`;
          return;
        }
        const scenarios = state.viewModel?.scenarios || [];
        if (!scenarios.length) {
          container.innerHTML = `<div class="helper">No scenarios generated yet.</div>`;
          return;
        }
          scenarios.forEach((scenario) => {
            const card = document.createElement("div");
            card.className = "glass card scenario-card";
            const imageUrl = resolveScenarioImage(state.runId, scenario);
            const title = scenario.name || scenario.id || scenario.scenario_id || "Scenario";
            const narrative = scenario.narrative || scenario.summary || scenario.story_text || "";
            const summary = escapeHtml(narrative);
            const axisStates = scenario.axis_states
              ? Object.entries(scenario.axis_states)
                  .map(([key, value]) => `${key}: ${value}`)
                  .join(" â€¢ ")
              : "";
          const imageHtml = imageUrl
            ? `<div class="scenario-media"><img src="${imageUrl}" alt="${title}" /></div>`
            : `<div class="scenario-media placeholder">No Image</div>`;
          card.innerHTML = `
              ${imageHtml}
              <div class="scenario-body">
                <h4>${title}</h4>
                <p>${summary || "Narrative pending."}</p>
                ${axisStates ? `<div class="scenario-meta">${axisStates}</div>` : ""}
              </div>
            `;
          container.appendChild(card);
        });
      }

      function renderWindDetail(evaluation) {
        const detail = document.getElementById("windDetail");
        if (!evaluation) {
          detail.textContent = "Select a cell for details.";
          return;
        }
        const bullets = evaluation.rationale_bullets || [];
        const triggers = evaluation.trigger_points || [];
        detail.innerHTML = `
          <div><strong>${evaluation.strategy_name || evaluation.strategy_id}</strong> vs <strong>${evaluation.scenario_name || evaluation.scenario_id}</strong></div>
          <div class="helper">Outcome: ${evaluation.outcome_label} | Score ${evaluation.score_0_100} | Confidence ${evaluation.confidence_0_1}</div>
          <ul>${bullets.map((item) => `<li>${item}</li>`).join("")}</ul>
          <div class="helper">Dominant forces: ${(evaluation.dominant_forces || []).join(", ") || "None"}</div>
          <div class="helper">Failed assumptions: ${(evaluation.failed_assumptions || []).join(", ") || "None"}</div>
          <div class="helper">Triggers: ${triggers.map((t) => t.description).join("; ") || "None"}</div>
        `;
      }

      function renderWindTunnel() {
        const matrix = document.getElementById("scoreMatrix");
        matrix.innerHTML = "";
        if (!state.viewModel) {
          matrix.textContent = "No run loaded.";
          return;
        }
        const evals = state.viewModel?.wind_tunnel_evaluations_v2?.evaluations || [];
        const rankings = state.viewModel?.wind_tunnel_evaluations_v2?.rankings || {};
        if (!evals.length) {
          matrix.textContent = "No scores yet.";
          return;
        }
        const scenarioMap = {};
        const strategyMap = {};
        evals.forEach((e) => {
          scenarioMap[e.scenario_id] = e.scenario_name || e.scenario_id;
          strategyMap[e.strategy_id] = e.strategy_name || e.strategy_id;
        });
        const scenarios = Object.keys(scenarioMap);
        const strategies = Object.keys(strategyMap);
        const rankingMap = {};
        (rankings.overall || []).forEach((entry) => {
          rankingMap[entry.strategy_id] = entry;
        });

        const table = document.createElement("table");
        const header = document.createElement("tr");
        header.innerHTML = `<th>Strategy</th>${scenarios.map((s) => `<th>${scenarioMap[s]}</th>`).join("")}<th>Robustness</th>`;
        table.appendChild(header);
        strategies.forEach((strategy) => {
          const row = document.createElement("tr");
          const cells = scenarios
            .map((scenario) => {
              const cell = evals.find((e) => e.strategy_id === strategy && e.scenario_id === scenario);
              if (!cell) return `<td>-</td>`;
              const confidence = cell.confidence_0_1 >= 0.75 ? "High" : cell.confidence_0_1 >= 0.5 ? "Med" : "Low";
              return `<td title="${cell.outcome_label}">
                  <div class="grade">${cell.grade_letter}</div>
                  <div class="score">${cell.score_0_100}</div>
                  <div class="confidence">${confidence}</div>
                </td>`;
            })
            .join("");
          const ranking = rankingMap[strategy];
          const robustness = ranking ? `${ranking.overall_score}/${ranking.min_score}` : "--";
          row.innerHTML = `<td>${strategyMap[strategy]}</td>${cells}<td>${robustness}</td>`;
          row.querySelectorAll("td").forEach((cell, idx) => {
            if (idx === 0 || idx === scenarios.length + 1) return;
            const scenarioId = scenarios[idx - 1];
            cell.addEventListener("click", () => {
              const evaluation = evals.find((e) => e.strategy_id === strategy && e.scenario_id === scenarioId);
              renderWindDetail(evaluation);
            });
          });
          table.appendChild(row);
        });
        matrix.appendChild(table);

        const insights = document.getElementById("insights");
        insights.innerHTML = "";
        const rec = state.viewModel?.wind_tunnel_evaluations_v2?.recommendations || {};
        const overall = (rankings.overall || [])[0];
        const fragile = (rankings.overall || []).slice(-1)[0];
        const card = document.createElement("div");
        card.className = "glass card";
        card.innerHTML = `
          <h4>Recommended Strategy Now</h4>
          <p>${rec.primary_recommended_strategy?.strategy_name || ""}</p>
          <p class="helper">${rec.primary_recommended_strategy?.rationale || ""}</p>
          <div class="helper">Best overall: ${overall?.strategy_name || "--"}</div>
          <div class="helper">Most fragile: ${fragile?.strategy_name || "--"}</div>
          <div class="helper">Triggers to watch: ${(rec.triggers_to_watch || []).map((t) => t.description).join("; ") || "None"}</div>
        `;
        insights.appendChild(card);

        const rankingTable = document.getElementById("rankingTable");
        rankingTable.innerHTML = "";
        if (rankings.overall && rankings.overall.length) {
          const rTable = document.createElement("table");
          rTable.innerHTML = `
            <tr>
              <th>Rank</th><th>Strategy</th><th>Overall</th><th>Min</th><th>Variance</th><th>Robustness</th>
            </tr>
            ${rankings.overall
              .map(
                (entry) =>
                  `<tr><td>${entry.rank}</td><td>${entry.strategy_name}</td><td>${entry.overall_score}</td><td>${entry.min_score}</td><td>${entry.variance}</td><td>${entry.robustness_index}</td></tr>`
              )
              .join("")}
          `;
          rankingTable.appendChild(rTable);
        }
      }

      function renderActionConsole() {
        const board = document.getElementById("actionBoard");
        const status = document.getElementById("actionStatus");
        const saveBtn = document.getElementById("actionSaveBtn");
        const editBtn = document.getElementById("actionEditBtn");
        if (saveBtn) saveBtn.disabled = !state.actionDirty;
        if (editBtn) editBtn.textContent = state.actionEditMode ? "Preview" : "Edit";
        board.innerHTML = "";
        if (!state.viewModel) {
          board.innerHTML = `<div class="helper">No run loaded.</div>`;
          if (status) status.textContent = "";
          return;
        }

        const actionConsole = state.actionConsole || buildActionConsoleFromViewModel();
        const items = Array.isArray(actionConsole?.items) ? actionConsole.items : [];
        const grouped = { P0: [], P1: [], P2: [] };
        items.forEach((item) => {
          const priority = String(item.priority || "P1").toUpperCase();
          const bucket = grouped[priority] ? priority : "P1";
          grouped[bucket].push(item);
        });

        const updated = actionConsole?.updated_at ? `Updated ${actionConsole.updated_at}` : "Not saved";
        if (status) {
          status.textContent = state.actionDirty ? `${updated} â€¢ Unsaved changes` : updated;
        }

        ["P0", "P1", "P2"].forEach((bucket) => {
          const card = document.createElement("div");
          card.className = "glass card";
          const entries = grouped[bucket];
          const content = entries.length
            ? entries
                .map((item) => renderActionItem(item, state.actionEditMode))
                .join("")
            : `<div class="helper">Define actions</div>`;
          card.innerHTML = `<h4>${bucket} Actions</h4>${content}`;
          board.appendChild(card);
        });
      }

      function buildActionConsoleFromViewModel() {
        const wind = state.viewModel?.wind_tunnel_evaluations_v2 || {};
        const rec = wind.recommendations || {};
        const primary = rec.primary_recommended_strategy || {};
        const primaryName = primary.strategy_name || "";
        const items = [];
        const add = (payload) => {
          if (!payload.title) return;
          items.push({
            id: payload.id || `action-${items.length + 1}`,
            priority: payload.priority || "P1",
            type: payload.type || "custom",
            title: payload.title,
            strategy: payload.strategy || "",
            scenario: payload.scenario || "",
            trigger: payload.trigger || "",
            owner: payload.owner || "",
            due: payload.due || "",
            status: payload.status || "open",
            source: payload.source || "wind_tunnel",
          });
        };
        (rec.hardening_actions || []).forEach((action) =>
          add({
            title: action,
            priority: "P0",
            type: "hardening",
            strategy: primaryName,
          })
        );
        (rec.hedge_actions || []).forEach((action) =>
          add({
            title: action,
            priority: "P1",
            type: "hedge",
          })
        );
        (rec.triggers_to_watch || []).forEach((trigger) => {
          if (typeof trigger === "object") {
            add({
              title: trigger.recommended_action || trigger.description || "",
              priority: "P2",
              type: "trigger",
              trigger: trigger.description || "",
              strategy: primaryName,
            });
          } else {
            add({
              title: trigger,
              priority: "P2",
              type: "trigger",
              trigger: trigger,
              strategy: primaryName,
            });
          }
        });
        return { run_id: state.runId, updated_at: null, items };
      }

      function renderActionItem(item, editable) {
        if (!editable) {
          const chips = [
            item.type ? `Type: ${item.type}` : null,
            item.strategy ? `Strategy: ${item.strategy}` : null,
            item.scenario ? `Scenario: ${item.scenario}` : null,
            item.status ? `Status: ${item.status}` : null,
            item.owner ? `Owner: ${item.owner}` : null,
            item.due ? `Due: ${item.due}` : null,
            item.source ? `Source: ${item.source}` : null,
          ]
            .filter(Boolean)
            .map((text) => `<span class="chip">${escapeHtml(text)}</span>`)
            .join("");
          const trigger = item.trigger ? `<div class="helper">Trigger: ${escapeHtml(item.trigger)}</div>` : "";
          return `
            <div class="action-item">
              <div class="action-title">${escapeHtml(item.title || "Action")}</div>
              <div class="action-meta">${chips || ""}</div>
              ${trigger}
            </div>
          `;
        }

        return `
          <div class="action-item" data-id="${escapeHtml(item.id || "")}">
            <div class="action-fields">
              <textarea data-field="title" placeholder="Action">${escapeHtml(item.title || "")}</textarea>
              <div class="action-row">
                <select data-field="priority">
                  ${["P0", "P1", "P2"]
                    .map((value) => `<option value="${value}" ${item.priority === value ? "selected" : ""}>${value}</option>`)
                    .join("")}
                </select>
                <select data-field="type">
                  ${["hardening", "hedge", "trigger", "custom"]
                    .map((value) => `<option value="${value}" ${item.type === value ? "selected" : ""}>${value}</option>`)
                    .join("")}
                </select>
                <select data-field="status">
                  ${["open", "in_progress", "done", "blocked"]
                    .map((value) => `<option value="${value}" ${item.status === value ? "selected" : ""}>${value}</option>`)
                    .join("")}
                </select>
              </div>
              <div class="action-row">
                <input data-field="strategy" placeholder="Strategy" value="${escapeHtml(item.strategy || "")}" />
                <input data-field="scenario" placeholder="Scenario" value="${escapeHtml(item.scenario || "")}" />
                <input data-field="trigger" placeholder="Trigger" value="${escapeHtml(item.trigger || "")}" />
              </div>
              <div class="action-row">
                <input data-field="owner" placeholder="Owner" value="${escapeHtml(item.owner || "")}" />
                <input data-field="due" placeholder="Due (YYYY-MM-DD)" value="${escapeHtml(item.due || "")}" />
                <input data-field="source" placeholder="Source" value="${escapeHtml(item.source || "")}" />
              </div>
            </div>
            <div class="action-actions">
              <button data-action="remove">Remove</button>
            </div>
          </div>
        `;
      }

      function ensureActionConsole() {
        if (!state.actionConsole) {
          state.actionConsole = buildActionConsoleFromViewModel();
        }
        if (!Array.isArray(state.actionConsole.items)) {
          state.actionConsole.items = [];
        }
      }

      function setActionDirty(value) {
        state.actionDirty = value;
        const saveBtn = document.getElementById("actionSaveBtn");
        if (saveBtn) saveBtn.disabled = !state.actionDirty;
        renderActionConsole();
      }

      function updateActionItem(id, field, value) {
        ensureActionConsole();
        const item = state.actionConsole.items.find((entry) => entry.id === id);
        if (!item) return;
        item[field] = value;
        setActionDirty(true);
      }

      function removeActionItem(id) {
        ensureActionConsole();
        state.actionConsole.items = state.actionConsole.items.filter((entry) => entry.id !== id);
        setActionDirty(true);
      }

      function addActionItem() {
        ensureActionConsole();
        state.actionConsole.items.unshift({
          id: `manual-${Date.now()}`,
          priority: "P1",
          type: "custom",
          title: "New action",
          strategy: "",
          scenario: "",
          trigger: "",
          owner: "",
          due: "",
          status: "open",
          source: "manual",
        });
        setActionDirty(true);
      }

      function renderChat() {
        const container = document.getElementById("chatMessages");
        if (!container) return;
        const wasAtBottom =
          container.scrollTop + container.clientHeight >= container.scrollHeight - 12;
        container.innerHTML = "";
        if (!Array.isArray(state.chatMessages)) {
          state.chatMessages = [];
        }
        if (!state.chatMessages.length) {
          container.innerHTML = `<div class="helper">No questions yet. Ask about the current run.</div>`;
          return;
        }
        state.chatMessages.forEach((message) => {
          const div = document.createElement("div");
          div.className = `chat-message ${message.role || "assistant"}`;
          const meta = message.role === "user" ? "You" : "Advisor";
          const sources = message.sources && message.sources.length
            ? `<div class="helper">Sources: ${message.sources.slice(0, 4).map((s) => s.id || s.type || "source").join(", ")}</div>`
            : "";
          div.innerHTML = `<div class="meta">${meta}</div><div class="content"></div>${sources}`;
          const contentEl = div.querySelector(".content");
          if (contentEl) {
            contentEl.textContent = message.content || "";
          }
          container.appendChild(div);
        });
        if (wasAtBottom) {
          container.scrollTop = container.scrollHeight;
        }
      }

      async function sendChat() {
        const input = document.getElementById("chatInput");
        const status = document.getElementById("chatStatus");
        if (!input || !status) return;
        const question = input.value.trim();
        if (!question) {
          status.textContent = "Enter a question.";
          return;
        }
        if (!state.runId) {
          status.textContent = "Load a run first.";
          return;
        }
        status.textContent = "Thinking...";
        state.chatMessages.push({ role: "user", content: question });
        renderChat();
        input.value = "";
        try {
          const response = await fetchJson("/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ run_id: state.runId, question }),
          });
          state.chatMessages.push({
            role: "assistant",
            content: response?.answer || "No response.",
            sources: response?.sources || [],
          });
          status.textContent = "";
          renderChat();
        } catch (err) {
          status.textContent = "Unable to reach chat service.";
        }
      }

      function renderRunPage() {
        renderCompanyCards();
        renderKPIs();
        renderBriefing();
        renderWorkflow();
        renderRunProgress();
        renderArtifacts();
        renderChat();
        renderAxisEbeGraph();
      }

      function clearView(reason) {
        state.viewModel = null;
        state.nodeEvents = [];
        state.normalization = [];
        state.latestLinks = [];
        state.logs = [];
        state.lastEventAt = null;
        state.actionConsole = null;
        state.actionDirty = false;
        state.uploadedDocs = [];
        const uploadInput = document.getElementById("uploadInput");
        if (uploadInput) uploadInput.value = "";
        const uploadStatus = document.getElementById("uploadStatus");
        if (uploadStatus) uploadStatus.textContent = "";
        updateContext(null, null);
          renderRunPage();
          renderSignalFeed();
          renderScenarioMatrix();
          renderAxisEbeGraph();
        renderScenarioCards();
        renderWindTunnel();
        renderActionConsole();
        renderTerminal([]);
        const runStatus = document.getElementById("runStatus");
        if (runStatus && reason) {
          runStatus.textContent = reason;
        }
      }

      function syncRunControls() {
        const context = resolveContext(state.viewModel);
        document.getElementById("controlCompany").value = context.company || "";
        if (context.horizon) {
          document.getElementById("controlHorizon").value = context.horizon;
        }
      }

      function normalizeRoute(route) {
        if (!route || route === "/") return "/runs";
        if (route.startsWith("/runs/")) return "/runs";
        return route;
      }

      function setRoute(route) {
        const normalized = normalizeRoute(route);
        document.querySelectorAll("[data-view]").forEach((section) => {
          section.classList.toggle("hidden", section.dataset.view !== normalized);
        });
        document.querySelectorAll(".nav-link").forEach((link) => {
          link.classList.toggle("active", normalizeRoute(link.dataset.route) === normalized);
        });
      }

      function getRunIdFromPath() {
        const match = window.location.pathname.match(/^\/(?:runs)\/(.+)$/);
        return match ? match[1] : null;
      }

        async function loadData(runIdOverride) {
          try {
            showEmptyState(false);
            state.lastEventAt = null;
            setStatus(true, "CONNECTING", "Fetching run data...");
            const scrollY = window.scrollY;
            let runId = runIdOverride || getRunIdFromPath() || state.runId;
          if (runId) {
            state.latestLinks = [];
          }
          let latest = null;
          if (!runId) {
            latest = await fetchLatest();
            runId = latest.run_id;
            state.latestLinks = latest.links || [];
          }
          if (!runId) {
            showEmptyState(true);
            clearView("No run loaded. Launch or load a run.");
            return false;
          }
          state.runId = runId;
          state.viewModel = await fetchArtifact(runId, "view_model.json");
          const runStatusValue = String(state.viewModel?.run_meta?.status || "").toUpperCase();
          const isFailed = runStatusValue === "FAIL" || runStatusValue === "FAILED";
          state.readOnly = Boolean(state.viewModel?.run_meta?.is_final) && !isFailed;
          if (state.launchingRunId === runId) {
            state.launchingRunId = null;
          }
            updateContext(state.viewModel, state.runId);
            state.nodeEvents = await fetchNodeEvents(runId);
            state.normalization = await fetchNormalization(runId);
            state.actionConsole = await fetchActionConsole(runId).catch(() => null);
            state.actionDirty = false;
            state.actionEditMode = false;
            const last = _lastNodeEvent();
            state.lastEventAt = last.timestamp;
            const logs = buildLogLines();
            state.logs = logs;
          renderTerminal(logs);
          applyReadOnlyState();
          syncRunControls();
          renderRunPage();
          renderSignalFeed();
          renderScenarioMatrix();
          renderScenarioCards();
          renderWindTunnel();
          renderActionConsole();
          refreshAdvancedPreview();
          refreshRuns();
          window.scrollTo(0, scrollY);
          setStatus(true);
          return true;
        } catch (err) {
          showEmptyState(true);
          clearView("No run loaded. Launch or load a run.");
          const status = err?.status;
          const message = status === 401 || status === 403 ? "UNAUTHORIZED" : "OFFLINE";
          const detail =
            status === 401 || status === 403
              ? "Access denied. Open Access and enter a valid API key."
              : undefined;
          setStatus(false, message, detail);
          return false;
        }
      }

      async function refreshRuns() {
        try {
          const payload = await fetchRuns();
          if (Array.isArray(payload)) {
            state.runs = payload;
            state.runLabels = {};
          } else {
            state.runs = payload.runs || [];
            state.runLabels = payload.labels || {};
          }
        } catch (err) {
          state.runs = [];
          state.runLabels = {};
        }
        const select = document.getElementById("runSelect");
        select.innerHTML = state.runs
          .map((run) => {
            const label = escapeHtml(state.runLabels[run] || run);
            return `<option value="${run}">${label}</option>`;
          })
          .join("");
        if (state.runId) {
          select.value = state.runId;
        }
        const runList = document.getElementById("runList");
        runList.innerHTML = "";
        state.runs.slice(0, 8).forEach((run) => {
          const div = document.createElement("div");
          div.className = "run-item";
          const label = document.createElement("span");
          label.className = "run-label";
          label.textContent = state.runLabels[run] || run;
          label.title = run;
          const actions = document.createElement("div");
          actions.className = "run-actions";
          const loadBadge = document.createElement("span");
          loadBadge.className = "badge";
          loadBadge.textContent = "Load";
          loadBadge.addEventListener("click", (event) => {
            event.stopPropagation();
            history.pushState({}, "", `/runs/${run}`);
            setRoute("/runs");
            loadData(run);
          });
          const removeBadge = document.createElement("span");
          removeBadge.className = "badge danger";
          removeBadge.textContent = "Remove";
          removeBadge.addEventListener("click", async (event) => {
            event.stopPropagation();
            if (!confirm("Remove run from list? This does not delete stored evidence.")) {
              return;
            }
            try {
              await deleteRun(run);
              if (state.runId === run) {
                state.runId = null;
                clearView("Run removed.");
                showEmptyState(true);
              }
              refreshRuns();
            } catch (err) {
              alert("Unable to remove run.");
            }
          });
          actions.appendChild(loadBadge);
          actions.appendChild(removeBadge);
          div.appendChild(label);
          div.appendChild(actions);
          div.addEventListener("click", () => {
            history.pushState({}, "", `/runs/${run}`);
            setRoute("/runs");
            loadData(run);
          });
          runList.appendChild(div);
        });
      }

      const draftKey = "scenarioops_run_draft";
      const draft = JSON.parse(localStorage.getItem(draftKey) || "{}");
      const advKey = "scenarioops_adv_overrides";
      const advDraft = JSON.parse(localStorage.getItem(advKey) || "{}");
      const draftVersionKey = "scenarioops_run_draft_version";
      const draftVersion = "2026-01-29-live-default";
      if (localStorage.getItem(draftVersionKey) !== draftVersion) {
        localStorage.setItem(draftVersionKey, draftVersion);
        localStorage.setItem(draftKey, JSON.stringify({ web: "true", mode: "live" }));
        Object.assign(draft, { web: "true", mode: "live" });
      }

      function updateDraft(patch) {
        Object.assign(draft, patch);
        localStorage.setItem(draftKey, JSON.stringify(draft));
        refreshAdvancedPreview();
      }

      function updateAdvDraft(patch) {
        Object.assign(advDraft, patch);
        localStorage.setItem(advKey, JSON.stringify(advDraft));
        refreshAdvancedPreview();
      }

      function collectAdvancedOverrides() {
        const overrides = {};
        const setIf = (key, value) => {
          if (value === undefined || value === null) return;
          if (typeof value === "string" && value.trim() === "") return;
          overrides[key] = value;
        };
        setIf("llm_model", document.getElementById("advLlmModel")?.value || "");
        setIf("gemini_model", document.getElementById("advLlmModel")?.value || "");
        setIf("search_model", document.getElementById("advSearchModel")?.value || "");
        setIf("summarizer_model", document.getElementById("advSummarizerModel")?.value || "");
        setIf("embed_model", document.getElementById("advEmbedModel")?.value || "");
        setIf("image_model", document.getElementById("advImageModel")?.value || "");
        const tempRaw = document.getElementById("advTemperature")?.value;
        if (tempRaw) setIf("temperature", parseFloat(tempRaw));
        const seedRaw = document.getElementById("advSeed")?.value;
        if (seedRaw) setIf("seed", parseInt(seedRaw, 10));
        setIf("sources_policy", document.getElementById("advSourcesPolicy")?.value || "");
        const allowWeb = document.getElementById("advAllowWeb")?.value;
        if (allowWeb) setIf("allow_web", allowWeb === "true");
        const simulate = document.getElementById("advSimulateEvidence")?.value;
        if (simulate) setIf("simulate_evidence", simulate === "true");
        const minSources = document.getElementById("advMinSourcesDomain")?.value;
        if (minSources) setIf("min_sources_per_domain", parseInt(minSources, 10));
        const minCitations = document.getElementById("advMinCitations")?.value;
        if (minCitations) setIf("min_citations_per_driver", parseInt(minCitations, 10));
        const minForces = document.getElementById("advMinForces")?.value;
        if (minForces) setIf("min_forces", parseInt(minForces, 10));
        const minForcesDomain = document.getElementById("advMinForcesDomain")?.value;
        if (minForcesDomain) setIf("min_forces_per_domain", parseInt(minForcesDomain, 10));
        const minEvidenceOk = document.getElementById("advMinEvidenceOk")?.value;
        if (minEvidenceOk) setIf("min_evidence_ok", parseInt(minEvidenceOk, 10));
        const minEvidenceTotal = document.getElementById("advMinEvidenceTotal")?.value;
        if (minEvidenceTotal) setIf("min_evidence_total", parseInt(minEvidenceTotal, 10));
        const maxFailed = document.getElementById("advMaxFailedRatio")?.value;
        if (maxFailed) setIf("max_failed_ratio", parseFloat(maxFailed));
        return overrides;
      }

      function buildSettingsOverrides() {
        const overrides = collectAdvancedOverrides();
        if (draft.model) {
          overrides.llm_model = draft.model;
          overrides.gemini_model = draft.model;
        }
        const forceWeb = draft.web === "true";
        const useCache = draft.cache !== "false";
        const runMode = draft.mode || "live";
        if (runMode === "mock") {
          overrides.llm_provider = "mock";
          overrides.mode = "demo";
          overrides.sources_policy = overrides.sources_policy || "fixtures";
          overrides.allow_web = false;
          overrides.simulate_evidence = true;
          return overrides;
        }
        overrides.llm_provider = overrides.llm_provider || "gemini";
        overrides.mode = overrides.mode || "live";
        if (forceWeb) {
          overrides.allow_web = true;
        } else if (overrides.allow_web === undefined) {
          overrides.allow_web = false;
        }
        if (overrides.simulate_evidence === undefined) {
          overrides.simulate_evidence = useCache;
        }
        return overrides;
      }

      function buildRerunPayload() {
        const runConfig = state.viewModel?.run_meta?.run_config || {};
        const userParams = runConfig.user_params || {};
        const prompt = state.viewModel?.prompt_manifest || {};
        const company = userParams.company || prompt.company_name || draft.company || "";
        const geography = userParams.geography || prompt.geography || draft.geography || "";
        const horizon =
          userParams.horizon ||
          userParams.horizon_months ||
          prompt.horizon_months ||
          draft.horizon ||
          60;
        const scope = userParams.scope || draft.scope || "country";
        const value = userParams.value || geography || company || "Global";
        const pack = userParams.pack || runConfig.pack || draft.pack || "";
        const settingsOverrides = runConfig.settings || buildSettingsOverrides();
        const mode = settingsOverrides.mode || runConfig.settings?.mode || draft.mode || "live";
        const generateStrategies =
          runConfig.generate_strategies !== undefined
            ? runConfig.generate_strategies
            : document.getElementById("generateStrategies").value === "true";
        return {
          scope,
          value,
          company,
          geography,
          horizon: parseInt(horizon, 10) || 60,
          pack,
          mock: mode === "demo",
          run_id: null,
          resume_from: null,
          input_docs: state.uploadedDocs,
          generate_strategies: generateStrategies,
          settings_overrides: settingsOverrides,
          force: true,
        };
      }

      function refreshAdvancedPreview() {
        const preview = document.getElementById("advancedPreview");
        if (!preview) return;
        preview.value = JSON.stringify(buildSettingsOverrides(), null, 2);
      }

      function applyAdvancedDraft() {
        const setValue = (id, value) => {
          const el = document.getElementById(id);
          if (!el || value === undefined || value === null) return;
          el.value = value;
        };
        setValue("advLlmModel", advDraft.llm_model || "");
        setValue("advSearchModel", advDraft.search_model || "");
        setValue("advSummarizerModel", advDraft.summarizer_model || "");
        setValue("advEmbedModel", advDraft.embed_model || "");
        setValue("advImageModel", advDraft.image_model || "");
        setValue("advTemperature", advDraft.temperature || "");
        setValue("advSeed", advDraft.seed || "");
        setValue("advSourcesPolicy", advDraft.sources_policy || "");
        setValue("advAllowWeb", typeof advDraft.allow_web === "boolean" ? String(advDraft.allow_web) : "");
        setValue("advSimulateEvidence", typeof advDraft.simulate_evidence === "boolean" ? String(advDraft.simulate_evidence) : "");
        setValue("advMinSourcesDomain", advDraft.min_sources_per_domain || "");
        setValue("advMinCitations", advDraft.min_citations_per_driver || "");
        setValue("advMinForces", advDraft.min_forces || "");
        setValue("advMinForcesDomain", advDraft.min_forces_per_domain || "");
        setValue("advMinEvidenceOk", advDraft.min_evidence_ok || "");
        setValue("advMinEvidenceTotal", advDraft.min_evidence_total || "");
        setValue("advMaxFailedRatio", advDraft.max_failed_ratio || "");
      }

      function attachAdvancedHandlers() {
        const ids = [
          "advLlmModel",
          "advSearchModel",
          "advSummarizerModel",
          "advEmbedModel",
          "advImageModel",
          "advTemperature",
          "advSeed",
          "advSourcesPolicy",
          "advAllowWeb",
          "advSimulateEvidence",
          "advMinSourcesDomain",
          "advMinCitations",
          "advMinForces",
          "advMinForcesDomain",
          "advMinEvidenceOk",
          "advMinEvidenceTotal",
          "advMaxFailedRatio",
        ];
        ids.forEach((id) => {
          const el = document.getElementById(id);
          if (!el) return;
          el.addEventListener("change", () => {
            updateAdvDraft(collectAdvancedOverrides());
          });
        });
      }

      const steps = [
        {
          title: "Scope",
          content: `
            <label>Company<input id="forgeCompany" placeholder="Microsoft" /></label>
            <label>Scope<select id="forgeScope"><option value="country">Country</option><option value="region">Region</option><option value="world">World</option></select></label>
            <label>Country<select id="forgeGeographySelect"></select></label>
            <label id="forgeGeographyCustomWrap" class="hidden">Custom Country<input id="forgeGeographyCustom" placeholder="Enter country" /></label>
            <label>Horizon (months)<input id="forgeHorizon" type="number" value="60" min="36" max="120" /></label>
          `,
        },
        {
          title: "Models",
          content: `
            <label>LLM Model<select id="forgeModel">
              <option value="gemini-3-flash-preview">Gemini 3 Flash</option>
              <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
              <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
            </select></label>
            <label>Agent Pack<select id="forgePack">
                <option value="Strategist">Strategist [end-to-end pipeline â†’ full run artifacts]</option>
                <option value="Analyst" disabled>Analyst [forces + clusters â†’ ranked forces] (coming soon)</option>
                <option value="Critic" disabled>Critic [strategy scoring â†’ wind tunnel outputs] (coming soon)</option>
            </select></label>
          `,
        },
        {
          title: "Depth & Creativity",
          content: `
            <label>Creativity<input id="forgeCreativity" type="range" min="1" max="10" value="5" /></label>
            <label>Depth<input id="forgeDepth" type="range" min="1" max="10" value="6" /></label>
            <label>Use cached intelligence<select id="forgeCache"><option value="true">Yes</option><option value="false">No</option></select></label>
            <label>Run Mode<select id="forgeMode"><option value="live">Live</option><option value="mock">Mock</option></select></label>
            <label>Force fresh web scan<select id="forgeWeb"><option value="true">Yes</option><option value="false">No</option></select></label>
          `,
        },
        {
          title: "Run Preview",
          content: `<div id="forgePreview" class="glass" style="padding:12px;">Review run summary here.</div>`,
        },
      ];

        let currentStep = 0;
        let syncWizardDraft = null;
        const wizardSteps = document.getElementById("wizardSteps");

      function attachWizardHandlers() {
        const company = document.getElementById("forgeCompany");
        const scope = document.getElementById("forgeScope");
        const geographySelect = document.getElementById("forgeGeographySelect");
        const geographyCustom = document.getElementById("forgeGeographyCustom");
        const geographyCustomWrap = document.getElementById("forgeGeographyCustomWrap");
        const horizon = document.getElementById("forgeHorizon");
        const model = document.getElementById("forgeModel");
        const pack = document.getElementById("forgePack");
        const creativity = document.getElementById("forgeCreativity");
        const depth = document.getElementById("forgeDepth");
        const cache = document.getElementById("forgeCache");
        const mode = document.getElementById("forgeMode");
        const web = document.getElementById("forgeWeb");

        if (company) company.value = draft.company || "";
        if (scope) scope.value = draft.scope || "country";
        if (geographySelect) {
          if (!geographySelect.options.length) {
            const countries = [
              "United States",
              "Canada",
              "United Kingdom",
              "Germany",
              "France",
              "Netherlands",
              "Spain",
              "Italy",
              "Sweden",
              "Japan",
              "South Korea",
              "India",
              "Singapore",
              "Australia",
              "United Arab Emirates",
              "Brazil",
              "Mexico",
              "Other",
            ];
            geographySelect.innerHTML = countries
              .map((country) => `<option value="${country}">${country}</option>`)
              .join("");
          }
          const draftGeo = draft.geography || "United States";
          const hasOption = Array.from(geographySelect.options).some((opt) => opt.value === draftGeo);
          geographySelect.value = hasOption ? draftGeo : "Other";
          if (!hasOption && geographyCustom) {
            geographyCustom.value = draftGeo;
          }
        }
        const updateGeoScope = () => {
          if (!geographySelect) return;
          if (scope?.value === "world") {
            geographySelect.disabled = true;
            if (geographyCustom) geographyCustom.disabled = true;
            if (geographyCustomWrap) geographyCustomWrap.classList.remove("hidden");
            if (geographyCustom) geographyCustom.value = "Global";
            geographySelect.value = "Other";
            return;
          }
          geographySelect.disabled = false;
          if (geographyCustom) geographyCustom.disabled = false;
          if (geographyCustomWrap) {
            geographyCustomWrap.classList.toggle("hidden", geographySelect.value !== "Other");
          }
        };
        updateGeoScope();
        if (horizon) horizon.value = draft.horizon || 60;
        if (model) model.value = draft.model || "gemini-3-flash-preview";
        if (pack) {
          const desiredPack = draft.pack || "Strategist";
          const option = Array.from(pack.options).find((opt) => opt.value === desiredPack);
          if (option && !option.disabled) {
            pack.value = desiredPack;
          } else {
            pack.value = "Strategist";
            updateDraft({ pack: "Strategist" });
          }
        }
        if (creativity) creativity.value = draft.creativity || 5;
        if (depth) depth.value = draft.depth || 6;
        if (cache) cache.value = draft.cache || "true";
        if (mode) mode.value = draft.mode || "live";
        if (web) web.value = draft.web || "true";

          const syncDraft = () => {
            updateGeoScope();
            const geoValue =
              geographySelect?.value === "Other"
                ? geographyCustom?.value || "Other"
                : geographySelect?.value;
            const patch = {};
            if (company) patch.company = company.value;
            if (scope) patch.scope = scope.value;
            if (geographySelect || geographyCustom) patch.geography = geoValue;
            if (horizon) patch.horizon = parseInt(horizon.value || "60", 10);
            if (model) patch.model = model.value;
            if (pack) patch.pack = pack.value;
            if (creativity) patch.creativity = parseInt(creativity.value || "5", 10);
            if (depth) patch.depth = parseInt(depth.value || "6", 10);
            if (cache) patch.cache = cache.value;
            if (mode) patch.mode = mode.value;
            if (web) patch.web = web.value;
            updateDraft(patch);
          };

          syncWizardDraft = syncDraft;
          [company, scope, geographySelect, geographyCustom, horizon, model, pack, creativity, depth, cache, mode, web].forEach((input) => {
            if (!input) return;
            input.addEventListener("change", syncDraft);
            input.addEventListener("input", syncDraft);
          });

          syncDraft();
        }

      function renderWizard() {
        wizardSteps.innerHTML = `<div class="section-title">${steps[currentStep].title}</div>${steps[currentStep].content}`;
        document.getElementById("prevStep").disabled = currentStep === 0;
        document.getElementById("nextStep").disabled = currentStep === steps.length - 1;
        document.getElementById("launchRun").style.display = currentStep === steps.length - 1 ? "inline-flex" : "none";
        attachWizardHandlers();
      }

        document.getElementById("prevStep").addEventListener("click", () => {
          if (typeof syncWizardDraft === "function") syncWizardDraft();
          currentStep = Math.max(0, currentStep - 1);
          renderWizard();
        });

        document.getElementById("nextStep").addEventListener("click", () => {
          if (typeof syncWizardDraft === "function") syncWizardDraft();
          currentStep = Math.min(steps.length - 1, currentStep + 1);
          renderWizard();
          if (currentStep === steps.length - 1) {
        const preview = document.getElementById("forgePreview");
        if (preview) {
            preview.innerHTML = `Company: ${draft.company || "Company"} | Geography: ${draft.geography || "Global"} | Horizon: ${draft.horizon || 60} months | Mode: ${draft.mode || "live"} | Pack: ${draft.pack || "Strategist"}`;
        }
        }
      });

      document.getElementById("launchRun").addEventListener("click", async () => {
        const runStatus = document.getElementById("runStatus");
        const launchBtn = document.getElementById("launchRun");
        if (!draft.company || !draft.company.trim()) {
          runStatus.textContent = "Company is required. Please enter a company name.";
          return;
        }
        runStatus.textContent = "Launching run...";
        launchBtn.disabled = true;
        const resumeFrom = document.getElementById("resumeNode").value || null;
        const resumeLast = document.getElementById("resumeLast").checked;
        const manualRunId = document.getElementById("resumeRunId").value.trim();
        const selectedRunId = document.getElementById("runSelect").value;
        const generateStrategies = document.getElementById("generateStrategies").value === "true";
        const latest = resumeLast ? await fetchLatest().catch(() => null) : null;
        const runId = manualRunId || (resumeFrom ? (resumeLast ? latest?.run_id : selectedRunId) : null);
        const plannedRunId = runId || (!resumeFrom ? generateRunId() : null);
        if (!resumeFrom) {
          state.runId = plannedRunId;
          state.launchingRunId = plannedRunId;
          clearView("Launching run...");
          updateContextDraft(plannedRunId);
          setStatus(true, "LAUNCHING", plannedRunId ? `Run ${plannedRunId} is launching.` : "Launching run...");
        }
        const settingsOverrides = buildSettingsOverrides();
        const runMode = draft.mode || "live";
        const mockMode = runMode === "mock";
        const payload = {
          scope: draft.scope || "country",
          value: draft.geography || draft.company || "Global",
          company: draft.company || "",
          geography: draft.geography || "",
          horizon: draft.horizon || 60,
          pack: draft.pack || "",
          mock: mockMode,
          run_id: plannedRunId,
          resume_from: resumeFrom || null,
          input_docs: state.uploadedDocs,
          generate_strategies: generateStrategies,
          settings_overrides: settingsOverrides,
        };
        if (resumeFrom && !runId) {
          runStatus.textContent = "Run ID required to resume from a node.";
          launchBtn.disabled = false;
          return;
        }
        try {
          const response = await fetchJson("/build", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const newRunId = response?.run_id || plannedRunId || runId;
          if (response?.reused) {
            const reason =
              response.reuse_reason === "in_progress"
                ? "Run already in progress"
                : response.reuse_reason === "completed"
                ? "Reusing completed run"
                : "Reusing run";
            runStatus.textContent = newRunId ? `${reason}: ${newRunId}` : reason;
          } else {
            runStatus.textContent = newRunId ? `Run launched: ${newRunId}` : "Run launched.";
          }
          if (newRunId) {
            history.pushState({}, "", `/runs/${newRunId}`);
            setRoute("/runs");
            await loadData(newRunId);
          } else {
            await loadData();
          }
        } catch (err) {
          runStatus.textContent = `Launch failed: ${err.message || "unknown error"}`;
          setStatus(false, "OFFLINE", "Launch failed. Check Access settings.");
          state.launchingRunId = null;
        } finally {
          state.launchingRunId = null;
          launchBtn.disabled = false;
        }
      });

      document.getElementById("newRunBtn").addEventListener("click", () => {
        state.uploadedDocs = [];
        const uploadInput = document.getElementById("uploadInput");
        if (uploadInput) uploadInput.value = "";
        const uploadStatus = document.getElementById("uploadStatus");
        if (uploadStatus) uploadStatus.textContent = "";
        currentStep = 0;
        renderWizard();
        document.getElementById("wizard").scrollIntoView({ behavior: "smooth" });
      });

      document.getElementById("openLatestBtn").addEventListener("click", async () => {
        try {
          const latest = await fetchLatest();
          if (latest?.run_id) {
            history.pushState({}, "", `/runs/${latest.run_id}`);
            setRoute("/runs");
            loadData(latest.run_id);
          }
        } catch (err) {
          setStatus(false, "NO RUNS", "No runs available yet. Launch a new run.");
          showEmptyState(true);
        }
      });

      document.getElementById("loadRunBtn").addEventListener("click", () => {
        const runId = document.getElementById("runSelect").value;
        if (!runId) return;
        history.pushState({}, "", `/runs/${runId}`);
        setRoute("/runs");
        loadData(runId);
      });

      document.getElementById("latestRunBtn").addEventListener("click", async () => {
        try {
          const latest = await fetchLatest();
          if (latest?.run_id) {
            document.getElementById("runSelect").value = latest.run_id;
            history.pushState({}, "", `/runs/${latest.run_id}`);
            setRoute("/runs");
            loadData(latest.run_id);
          }
        } catch (err) {
          setStatus(false, "NO RUNS", "No runs available yet. Launch a new run.");
          showEmptyState(true);
        }
      });

      document.getElementById("rerunBtn").addEventListener("click", async () => {
        const runStatus = document.getElementById("runStatus");
        if (!state.viewModel) {
          runStatus.textContent = "Load a run before rerunning.";
          return;
        }
        runStatus.textContent = "Rerunning...";
        const rerunBtn = document.getElementById("rerunBtn");
        rerunBtn.disabled = true;
        try {
          const payload = buildRerunPayload();
          const response = await fetchJson("/build", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const newRunId = response?.run_id;
          runStatus.textContent = newRunId ? `Rerun launched: ${newRunId}` : "Rerun launched.";
          if (newRunId) {
            history.pushState({}, "", `/runs/${newRunId}`);
            setRoute("/runs");
            await loadData(newRunId);
          }
        } catch (err) {
          runStatus.textContent = "Rerun failed.";
        } finally {
          rerunBtn.disabled = false;
        }
      });

      document.getElementById("retryFailedBtn").addEventListener("click", async () => {
        const runStatus = document.getElementById("runStatus");
        const failedNode = latestFailedNode();
        if (!failedNode) {
          runStatus.textContent = "No failed node detected for this run.";
          return;
        }
        if (!state.runId) {
          runStatus.textContent = "Load a run before retrying.";
          return;
        }
        document.getElementById("resumeLast").checked = false;
        document.getElementById("resumeNode").value = failedNode;
        document.getElementById("resumeRunId").value = state.runId;
        document.getElementById("launchRun").click();
      });

      document.getElementById("uploadInput").addEventListener("change", async (event) => {
        const files = event.target.files || [];
        if (!files.length) return;
        const status = document.getElementById("uploadStatus");
        status.textContent = "Uploading...";
        try {
          const result = await uploadFiles(files);
          state.uploadedDocs = result.files || [];
          status.textContent = `Uploaded ${state.uploadedDocs.length} file(s).`;
        } catch (err) {
          status.textContent = "Upload failed. python-multipart may be missing.";
        }
      });

      document.getElementById("toggleRawLogs").addEventListener("change", () => {
        renderTerminal(buildLogLines());
      });

      document.getElementById("chatSend")?.addEventListener("click", sendChat);
      document.getElementById("chatInput")?.addEventListener("keydown", (event) => {
        if (event.key === "Enter" && !event.shiftKey) {
          event.preventDefault();
          sendChat();
        }
      });

      document.getElementById("actionGenerateBtn")?.addEventListener("click", async () => {
        const status = document.getElementById("actionStatus");
        if (!state.runId) {
          if (status) status.textContent = "Load a run before generating actions.";
          return;
        }
        if (status) status.textContent = "Generating actions...";
        try {
          const payload = await generateActionConsole(state.runId);
          state.actionConsole = payload;
          state.actionDirty = false;
          state.actionEditMode = false;
          renderActionConsole();
          if (status) status.textContent = "Actions generated.";
        } catch (err) {
          if (status) status.textContent = "Unable to generate actions.";
        }
      });

      document.getElementById("actionAddBtn")?.addEventListener("click", () => {
        addActionItem();
      });

      document.getElementById("actionEditBtn")?.addEventListener("click", () => {
        state.actionEditMode = !state.actionEditMode;
        const btn = document.getElementById("actionEditBtn");
        if (btn) btn.textContent = state.actionEditMode ? "Preview" : "Edit";
        renderActionConsole();
      });

      document.getElementById("actionSaveBtn")?.addEventListener("click", async () => {
        const status = document.getElementById("actionStatus");
        if (!state.runId) {
          if (status) status.textContent = "Load a run before saving actions.";
          return;
        }
        ensureActionConsole();
        if (status) status.textContent = "Saving actions...";
        try {
          const payload = await saveActionConsole(state.runId, state.actionConsole);
          state.actionConsole = payload;
          state.actionDirty = false;
          state.actionEditMode = false;
          const btn = document.getElementById("actionEditBtn");
          if (btn) btn.textContent = "Edit";
          renderActionConsole();
          if (status) status.textContent = "Actions saved.";
        } catch (err) {
          if (status) status.textContent = "Unable to save actions.";
        }
      });

      const actionBoard = document.getElementById("actionBoard");
      actionBoard?.addEventListener("input", (event) => {
        if (!state.actionEditMode) return;
        const target = event.target;
        if (!target || !target.dataset) return;
        const field = target.dataset.field;
        if (!field) return;
        const wrapper = target.closest(".action-item");
        const id = wrapper?.dataset?.id;
        if (!id) return;
        updateActionItem(id, field, target.value);
      });

      actionBoard?.addEventListener("change", (event) => {
        if (!state.actionEditMode) return;
        const target = event.target;
        if (!target || !target.dataset) return;
        const field = target.dataset.field;
        if (!field) return;
        const wrapper = target.closest(".action-item");
        const id = wrapper?.dataset?.id;
        if (!id) return;
        updateActionItem(id, field, target.value);
      });

      actionBoard?.addEventListener("click", (event) => {
        if (!state.actionEditMode) return;
        const target = event.target;
        if (!target) return;
        if (target.dataset?.action === "remove") {
          const wrapper = target.closest(".action-item");
          const id = wrapper?.dataset?.id;
          if (!id) return;
          removeActionItem(id);
        }
      });

      document.querySelectorAll(".nav-link").forEach((link) => {
        link.addEventListener("click", (event) => {
          event.preventDefault();
          const route = link.dataset.route;
          history.pushState({}, "", route);
          setRoute(route);
        });
      });

      window.addEventListener("popstate", () => setRoute(window.location.pathname));

      const resumeNode = document.getElementById("resumeNode");
      resumeNode.innerHTML = `<option value="">Start</option>${resumeSteps
        .map((step) => `<option value="${step}">${step.replace(/_/g, " ")}</option>`)
        .join("")}`;

      document.getElementById("accessBtn").addEventListener("click", () => {
        document.getElementById("accessModal").classList.remove("hidden");
        document.getElementById("apiBaseInput").value = apiBase() || window.location.origin;
        document.getElementById("apiKeyInput").value = localStorage.getItem("scenarioops_api_key") || "";
      });

      document.getElementById("closeAccess").addEventListener("click", () => {
        document.getElementById("accessModal").classList.add("hidden");
      });

      document.getElementById("saveAccess").addEventListener("click", () => {
        localStorage.setItem("scenarioops_api_base", document.getElementById("apiBaseInput").value.trim());
        localStorage.setItem("scenarioops_api_key", document.getElementById("apiKeyInput").value.trim());
        document.getElementById("accessModal").classList.add("hidden");
        refreshApiKeyStatus();
        loadData();
      });

      document.getElementById("configBtn").addEventListener("click", async () => {
        document.getElementById("configModal").classList.remove("hidden");
        const editor = document.getElementById("configEditor");
        const status = document.getElementById("configStatus");
        status.textContent = "Loading...";
        try {
          const payload = await fetchConfig();
          editor.value = JSON.stringify(payload.settings || {}, null, 2);
          editor.readOnly = !payload.is_admin;
          status.textContent = payload.is_admin ? "Admin access granted." : "Read-only access.";
        } catch (err) {
          status.textContent = "Unable to load config. Check API key.";
          editor.value = "";
        }
      });

      document.getElementById("closeConfig").addEventListener("click", () => {
        document.getElementById("configModal").classList.add("hidden");
      });

      document.getElementById("saveConfig").addEventListener("click", async () => {
        const status = document.getElementById("configStatus");
        try {
          const settings = JSON.parse(document.getElementById("configEditor").value || "{}");
          await saveConfig(settings);
          status.textContent = "Config saved.";
        } catch (err) {
          status.textContent = "Config save failed.";
        }
      });

      document.getElementById("helpBtn").addEventListener("click", () => {
        document.getElementById("helpModal").classList.remove("hidden");
      });

      document.getElementById("closeHelp").addEventListener("click", () => {
        document.getElementById("helpModal").classList.add("hidden");
      });

      applyAdvancedDraft();
      updateAdvDraft(advDraft);
      attachAdvancedHandlers();

      let activeLogTab = "all";
      document.querySelectorAll("#logTabs .tab").forEach((tab) => {
        tab.addEventListener("click", () => {
          document.querySelectorAll("#logTabs .tab").forEach((t) => t.classList.remove("active"));
          tab.classList.add("active");
          activeLogTab = tab.dataset.log;
          if (activeLogTab === "all") {
            renderTerminal(buildLogLines());
            return;
          }
          const filtered = buildLogLines().filter((line) => line.text.toLowerCase().includes(activeLogTab));
          renderTerminal(filtered);
        });
      });

      function startPolling() {
        let delay = 8000;
        const maxDelay = 60000;
        async function poll() {
          const success = await loadData();
          delay = success ? 8000 : Math.min(maxDelay, Math.round(delay * 1.5));
          setTimeout(poll, delay);
        }
        poll();
      }

      renderWizard();
      setRoute(window.location.pathname);
      refreshRuns();
      loadData();
      refreshApiKeyStatus();
      startPolling();
    </script>

  </body>
</html>
